
<script src="/docsgo/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=docsgo/livereload" data-no-instant defer></script><div class="footer-content ">
    <div class="row" style="display: flex; justify-content: center; align-items: center;">

        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img class="float-right" src="http://localhost:1313/docsgo/punching.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
        <div class="col-md-6 col-md-offset-1 vcenter">
            <div class="quote" style="font-size: 1.5em; font-family: 'Courier New', Courier, monospace; color: #888; margin-left: 20px; margin-right: 20px; text-align: center;">â€œæˆåŠŸç»éå¶ç„¶ã€‚ è¿™æ˜¯åŠªåŠ›å·¥ä½œã€åšæŒä¸æ‡ˆã€å­¦ä¹ ã€å­¦ä¹ ã€ç‰ºç‰²ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œçƒ­çˆ±ä½ æ­£åœ¨åšçš„äº‹æƒ…æˆ–æ­£åœ¨å­¦ä¹ çš„äº‹æƒ…ã€‚â€ - è´åˆ©</div>
        </div>
        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img src="http://localhost:1313/docsgo/success.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
    </div>
</div>
<div id="article" style="padding-left: 20px; padding-right: 20px;">
    <div class="article-title">
        <h1>Ansible å…¥é—¨</h1>
    </div>
    
    
    <time datetime="2024-04-07T21:14:26&#43;08:00">April 7, 2024</time>
    <hr/>
    <aside>
        <p> ç›®å½•: </p>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#-ansble--å®éªŒç¯å¢ƒ">ğŸš€ Ansble  å®éªŒç¯å¢ƒ</a></li>
    <li><a href="#-doc">ğŸ“’ Doc</a>
      <ul>
        <li><a href="#-ansibleçš„æ¶æ„å’Œè®¾è®¡">â›³ï¸ Ansibleçš„æ¶æ„å’Œè®¾è®¡</a></li>
        <li><a href="#-ansible-inventories">ğŸ„ Ansible inventories</a></li>
        <li><a href="#-ansible-modules">ğŸ“¦ Ansible Modules</a></li>
        <li><a href="#-ansible-playbook">ğŸ““ Ansible Playbook</a></li>
        <li><a href="#-ansible-playbook-æ·±å…¥">ğŸš€ Ansible Playbook æ·±å…¥</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </aside>
    <hr>
    <div class="post">
        <div id="content-font">
            <p>ansible å’Œ Terraform æ˜¯æœ€å—æ¬¢è¿çš„åŸºç¡€è®¾æ–½ä»£ç ä¹‹ä¸€</p>
<p>ä»è¡¨é¢ä¸Šçœ‹ï¼ŒAnsible å¯ä»¥å®Œæˆä¸ Terraform ç›¸åŒç±»å‹çš„åŸºç¡€è®¾æ–½é…ç½®ã€‚ç„¶è€Œï¼Œå®ƒä»¬åœ¨æ¶æ„ä¸Šæœ‰æ ¹æœ¬çš„ä¸åŒâ€”â€”Ansible æ˜¯ä¸€ä¸ªå‘½ä»¤å¼è„šæœ¬æ‰§è¡Œå¼•æ“ï¼Œå®ƒå°†æŒ‰ç…§ä»£ç ä¸­åˆ—å‡ºçš„é¡ºåºè¿è¡Œä»»åŠ¡ï¼Œè€Œ Terraform æ˜¯ä¸€ä¸ªå£°æ˜å¼æ‰§è¡Œå¼•æ“ï¼Œå®ƒå°†å¹¶è¡ŒåŒ–å½¼æ­¤ä¸ç›´æ¥ä¾èµ–çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œé™¤äº†éå¸¸å°çš„ä»£ç åº“ä¹‹å¤–ï¼ŒTerraform çš„æ‰§è¡Œé€Ÿåº¦æ¯” Ansible å¿«å¾—å¤šã€‚</p>
<p>ï¼ˆé¡ºä¾¿è¯´ä¸€å¥ï¼Œå¤§è§„æ¨¡æ‰§è¡Œé€Ÿåº¦æ…¢æ˜¯ Ansible çš„ä¸»è¦å¼±ç‚¹ã€‚ï¼‰</p>
<p>Terraform åŸºäºå›¾å½¢çš„æ€§è´¨è¿˜ä½¿å¾—å¯ä»¥ä½¿ç”¨ä¸åˆ›å»ºåŸºç¡€è®¾æ–½å®Œå…¨ç›¸åŒçš„ä»£ç æ¥é”€æ¯åŸºç¡€è®¾æ–½ï¼Œè€Œ Ansible éœ€è¦å•ç‹¬çš„å‰§æœ¬æ¥åˆ›å»ºå’Œé”€æ¯ã€‚å¯¹äºå®šæœŸåˆ›å»ºå’Œé”€æ¯çš„ç¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œå¼€å‘/æµ‹è¯•/ç™»å°ï¼‰ï¼ŒTerraform çš„æ–¹æ³•æ—¢å¯ä»¥å¤§å¹…æé«˜ç”Ÿäº§åŠ›ï¼Œåˆå¯ä»¥å‡å°‘äººä¸ºé”™è¯¯çš„æœºä¼šã€‚</p>
<p>æœ€åï¼Œè™½ç„¶è¿™ä¸ä¸€å®šæ˜¯ Ansible çš„æŠ€æœ¯ç¼ºé™·ï¼Œä½†åœ¨åŸºç¡€è®¾æ–½é…ç½®æ–¹é¢ï¼ŒTerraform è¿„ä»Šä¸ºæ­¢æ‹¥æœ‰æœ€å¤šçš„ç¤¾åŒºå’Œå¼€å‘ç†å¿µã€‚ä¸ä»»ä½•å…¶ä»–åŸºç¡€è®¾æ–½é…ç½®å·¥å…·ç›¸æ¯”ï¼Œæ‚¨æ›´æœ‰å¯èƒ½æ‰¾åˆ° Terraform çš„æ”¯æŒèµ„æºï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›ä»¥ç¼–ç¨‹æ–¹å¼é…ç½®çš„æ–°äº§å“å¯èƒ½ä¼šé¦–å…ˆåœ¨ Terraform ä¸­è·å¾—æ”¯æŒã€‚</p>
<p>Ansibleï¼šå¼€æºçš„é…ç½®ç®¡ç†ã€è½¯ä»¶é…ç½®å’Œåº”ç”¨éƒ¨ç½²å·¥å…·é›†ã€‚</p>
<ul>
<li>è½¯ä»¶å®šä¹‰åŸºç¡€è®¾æ–½</li>
</ul>
<p>Modulesï¼šAnsibleæˆåŠŸçš„ä¸€ä¸ªä¸»è¦å› ç´ æ˜¯å› ä¸ºæœ‰å¤§é‡çš„æ¨¡å—å¯ä¾›å…¬å¼€ä½¿ç”¨ã€‚</p>
<h2 id="-ansble--å®éªŒç¯å¢ƒ">ğŸš€ Ansble  å®éªŒç¯å¢ƒ</h2>
<ol>
<li>ç¯å¢ƒï¼šDocker - MACï¼ˆDocker Desktopï¼‰</li>
<li>Docker compose å»ºç«‹ç¯å¢ƒ</li>
<li>Ansible æ˜¯æ— ä»£ç†çš„æ¶æ„ï¼ŒSSH é…ç½®ä¸»æœºä¹‹é—´æ— å¯†ç è¿æ¥</li>
</ol>
<p>ğŸ§ª<a href="https://github.com/spurin/diveintoansible-lab?tab=readme-ov-file">å®éªŒ</a></p>
<p>è®¿é—®ï¼šhttp://localhost:1000</p>
<p>å¯†ç ï¼šroot/ansibleã€password</p>
<p>è¿æ¥åˆ°å…¶ä»–ä¸»æœºä¸å¸Œæœ›ä½¿ç”¨å¯†ç ï¼š</p>
<ul>
<li>SSH ç§æœ‰å’Œå…¬é’¥</li>
</ul>
<p>æ§åˆ¶ç«¯ ç§é’¥å°†ä¸è¢«æ§ç«¯çš„å…¬é’¥è¿›è¡ŒéªŒè¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible@ubuntu-c:~$ ssh-keygen 
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>+---<span style="color:#f92672">[</span>RSA 3072<span style="color:#f92672">]</span>----+
</span></span><span style="display:flex;"><span>|*...<span style="color:#f92672">==</span>B<span style="color:#f92672">=</span>oo.      |
</span></span><span style="display:flex;"><span>|oo .o++oo. o     |
</span></span><span style="display:flex;"><span>|. .  o o<span style="color:#f92672">=</span> + .    |
</span></span><span style="display:flex;"><span>|   . ..* <span style="color:#f92672">=</span> o     |
</span></span><span style="display:flex;"><span>|  . . <span style="color:#f92672">=</span> S o . o  |
</span></span><span style="display:flex;"><span>| . + . o . . o . |
</span></span><span style="display:flex;"><span>|  . o . o . . .  |
</span></span><span style="display:flex;"><span>| . .   o .   . . |
</span></span><span style="display:flex;"><span>| .E.    o     .  |
</span></span><span style="display:flex;"><span>+----<span style="color:#f92672">[</span>SHA256<span style="color:#f92672">]</span>-----+
</span></span><span style="display:flex;"><span>ansible@ubuntu-c:~$ ls .ssh/
</span></span><span style="display:flex;"><span>id_rsa  id_rsa.pub  known_hosts  known_hosts.old
</span></span><span style="display:flex;"><span>ansible@ubuntu-c:~$ cat .ssh/id_rsa.pub 
</span></span><span style="display:flex;"><span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDFYBkgsKG7u9s/pc+S8iUsdlYvVslFqsYD1XZ364pHXaaOO7th1JuFDa9p20rFzDT3cfpBvyOvgyIfFMNADZ53dMODBDAWpOQHcMPKaCFeiom/dTl5ub2NKIsQeN1HApfVqOXKpEUdXPuAIr+UJoMLegX8ASvdprn/X5LnsluOdCTk44fA5WxFadAJlfk7dNE2dh8XDG/Gg6M/37n+Ncaed3KHqja6y329easyR/bMwPh9XfHOwqLovgVgI2UVZDNmnsCCVNYfbpFy4bbpszGuVhvymwDr/nRZkx2b3lSDtJfKucopxG+HXphDgC7/8/OzFEVAv7voLeO9ZWIzIVdPCXy2u86peP+3crDKu+DyZqY7ZszMKTKed52kqubF+qD7hWssajSYrdJgduttTZVD/AsRrAIyN4dkyi7C8kTHOScAgvgUIhsFcN90oufnStV0Si9+Z+7Hn+6dtkRmO7Poxi2vq7dNcWsajASQLthrnpD6WpPjj2wxSoRs+GbGQIM<span style="color:#f92672">=</span> ansible@ubuntu-c
</span></span></code></pre></div><ul>
<li>å…¬é’¥ï¼šæ·»åŠ äº†ç”¨æˆ· ä¸»æœºå</li>
</ul>
<p>å¤åˆ¶å…¬é’¥ &mdash; &gt; å…¶ä»–ä¸»æœº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> server in ubuntu1 ubuntu2 ubuntu3 centos1 centos2 centos3; <span style="color:#66d9ef">do</span> ssh-copy-id ansible@<span style="color:#e6db74">${</span>server<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>è§£å†³æ‰‹åŠ¨è¾“å…¥å¯†ç æ–¹æ³•ï¼š<code>sshpass</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo apt updat
</span></span><span style="display:flex;"><span>$ sudo apt install sshpass
</span></span></code></pre></div><p>åˆ›å»ºä¸€ä¸ªï¼špassword.txtå¯†ç æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ echo passowrd &gt;&gt; password.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> user in root ansible
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">for</span> node in centos ubuntu
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">for</span> instance in <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>       c<span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>node<span style="color:#e6db74">}${</span>instance<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>åˆ é™¤å¯†ç æ–‡ä»¶</p>
<pre tabindex="0"><code>rm password.txt
</code></pre><p>ğŸ¯ å¿«é€Ÿæµ‹è¯•</p>
<ul>
<li>æ£€æŸ¥</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ansible -i,ubuntu1,ubuntu2,ubuntu3,centos1,centos2,centos3 all -m ping
</span></span></code></pre></div><p>åˆ é™¤äº† <code>rm .ssh/known_hosts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ git clone https://github.com/spurin/diveintoansible.git
</span></span></code></pre></div><h2 id="-doc">ğŸ“’ Doc</h2>
<h3 id="-ansibleçš„æ¶æ„å’Œè®¾è®¡">â›³ï¸ Ansibleçš„æ¶æ„å’Œè®¾è®¡</h3>
<h3 id="-ansible-inventories">ğŸ„ Ansible inventories</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/01$ cat ansible.cfg 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>defaults<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>inventory <span style="color:#f92672">=</span> hosts
</span></span><span style="display:flex;"><span>ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/01$ cat hosts 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>all<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos1
</span></span></code></pre></div><p>åœ¨åˆ é™¤æ–‡ä»¶<code>rm -rf /home/ansible/.ssh/known_hosts</code></p>
<p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110210608919.png" alt="image-20240110210608919"
    
    
    />
</p>
<p>Ansible å°è¯•ä½¿ç”¨ ssh è¿æ¥ centos1ï¼šç­‰å¾…æ‰‹åŠ¨è¾“å…¥</p>
<ul>
<li>å¯ä»¥ä½¿ç”¨ å¿½ç•¥æ£€æŸ¥ï¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ANSIBLE_HOST_KEY_CHECKING<span style="color:#f92672">=</span>False
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110210850867.png" alt="image-20240110210850867"
    
    
    />
</p>
<p>è™½ç„¶ç¯å¢ƒå˜é‡å¾ˆç®€å•ï¼Œä¸å¸Œæœ›æ¯æ¬¡éƒ½è®°ä½ä½¿ç”¨å®ƒ</p>
<p>ğŸ¯ <code>ansible.cfg</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>defaults<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>inventory <span style="color:#f92672">=</span> hosts
</span></span><span style="display:flex;"><span>host_key_checking <span style="color:#f92672">=</span> False
</span></span></code></pre></div><p>å¤šä¸»æœºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/03$ cat hosts 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>centos<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos1
</span></span><span style="display:flex;"><span>centos2
</span></span><span style="display:flex;"><span>centos3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ubuntu<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu1
</span></span><span style="display:flex;"><span>ubuntu2
</span></span><span style="display:flex;"><span>ubuntu3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ansible all -m ping 
</span></span><span style="display:flex;"><span>$ ansible centos -m ping
</span></span><span style="display:flex;"><span>$ ansible ubuntu -m ping
</span></span><span style="display:flex;"><span>$ ansible <span style="color:#e6db74">&#39;*&#39;</span> -m ping
</span></span></code></pre></div><p>é€‰é¡¹ï¼š<code>-o</code>  ç®€è¦è¾“å‡º</p>
<p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110211616276.png" alt="image-20240110211616276"
    
    
    />
</p>
<p>é€‰é¡¹ï¼š<code>--list-hosts</code> <img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110211737464.png" alt="image-20240110211737464"
    
    
    />
</p>
<p>æ­£åˆ™ï¼š</p>
<ul>
<li><code>~</code>: åŒ¹é…ä»¥æŒ‡å®šæ¨¡å¼å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚</li>
<li><code>.*</code>: åŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„å­—ç¬¦ï¼ˆé™¤äº†æ¢è¡Œç¬¦ï¼‰ã€‚</li>
<li><code>3</code>: åŒ¹é…å­—ç¬¦ &ldquo;3&rdquo;ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ansible ~.*3 --list-hosts
</span></span><span style="display:flex;"><span>  hosts <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    centos3
</span></span><span style="display:flex;"><span>    ubuntu3
</span></span></code></pre></div><p>ğŸ„ ä»¥ sudo æ‰§è¡Œ</p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ ansibleçš„å‡çº§æƒé™ - rootæƒé™</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>control<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu-c ansible_connection<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>centos<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos1 ansible_user<span style="color:#f92672">=</span>root ansible_port<span style="color:#f92672">=</span><span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>centos2 ansible_user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>centos3 ansible_user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ubuntu<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu1 ansible_become<span style="color:#f92672">=</span>true ansible_become_pass<span style="color:#f92672">=</span>password
</span></span><span style="display:flex;"><span>ubuntu2 ansible_become<span style="color:#f92672">=</span>true ansible_become_pass<span style="color:#f92672">=</span>password
</span></span><span style="display:flex;"><span>ubuntu3 ansible_become<span style="color:#f92672">=</span>true ansible_become_pass<span style="color:#f92672">=</span>password
</span></span></code></pre></div><p>å®éªŒç¯å¢ƒå¯ä»¥è¿™æ ·åšï¼Œåœ¨ç”Ÿäº§ä¸­é€šå¸¸ä»¥æ™®é€šç”¨æˆ·è¿æ¥åˆ°ä¸»æœºï¼Œç„¶åå†å‡çº§åˆ° sudo ç”¨æˆ·</p>
<p>å½“ ssh é»˜è®¤ç«¯å£è¢«ä¿®æ”¹åï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>centos1 ansible_user<span style="color:#f92672">=</span>root ansible_port<span style="color:#f92672">=</span><span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>centos1:2222 ansible_user<span style="color:#f92672">=</span>root
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110214146135.png" alt="image-20240110214146135"
    
    
    />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>control<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu-c ansible_connection<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>centos<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos1 ansible_user<span style="color:#f92672">=</span>root ansible_port<span style="color:#f92672">=</span><span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>centos<span style="color:#f92672">[</span>2:3<span style="color:#f92672">]</span> ansible_user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ubuntu<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu<span style="color:#f92672">[</span>1:3<span style="color:#f92672">]</span> ansible_become<span style="color:#f92672">=</span>true ansible_become_pass<span style="color:#f92672">=</span>password
</span></span></code></pre></div><p>ğŸš€ å­ vars</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>control<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu-c ansible_connection<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>centos<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos1 ansible_port<span style="color:#f92672">=</span><span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>centos<span style="color:#f92672">[</span>2:3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>centos:vars<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ansible_user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ubuntu<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ubuntu<span style="color:#f92672">[</span>1:3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ubuntu:vars<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ansible_become<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>ansible_become_pass<span style="color:#f92672">=</span>password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>linux:children<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>centos
</span></span><span style="display:flex;"><span>ubuntu
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240110215507024.png" alt="image-20240110215507024"
    
    
    />
</p>
<p>ğŸš€ ä½¿ç”¨ [all:var] å°†æ‰€æœ‰å˜é‡åº”ç”¨äºä¸»æœº</p>
<ul>
<li>ä¸ä¼šè¦†ç›–åŸæœ‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>all:vars<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ansible_port<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>defaults<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>inventory <span style="color:#f92672">=</span> hosts.json
</span></span><span style="display:flex;"><span>host_key_checking <span style="color:#f92672">=</span> False
</span></span></code></pre></div><p>ğŸš€ hosts.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">control</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ubuntu-c</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_connection</span>: <span style="color:#ae81ff">local</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">centos</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">centos1</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ansible_port</span>: <span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">centos2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">centos3</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_user</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ubuntu</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ubuntu1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ubuntu2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ubuntu3</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_become</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ansible_become_pass</span>: <span style="color:#ae81ff">password</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">linux</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">children</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">centos</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ubuntu</span>:
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥æ˜¯ json æ–‡ä»¶</p>
<p>ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>ansible.cfg  hosts  hosts.json  hosts.yaml
</span></span><span style="display:flex;"><span>$ ansible all -i hosts.yaml --list-hosts
</span></span><span style="display:flex;"><span>  hosts <span style="color:#f92672">(</span>7<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    ubuntu-c
</span></span><span style="display:flex;"><span>    centos1
</span></span><span style="display:flex;"><span>    centos2
</span></span><span style="display:flex;"><span>    centos3
</span></span><span style="display:flex;"><span>    ubuntu1
</span></span><span style="display:flex;"><span>    ubuntu2
</span></span><span style="display:flex;"><span>    ubuntu3
</span></span></code></pre></div><p>å…¶ä»–é€‰é¡¹ ï¼š-e æŒ‡å®šé¢å¤–å˜é‡</p>
<h3 id="-ansible-modules">ğŸ“¦ Ansible Modules</h3>
<h4 id="-setup">ğŸ§© setup</h4>
<p>æ”¶é›†è¿œç¨‹ä¸»æœºä¸­æœ‰ç”¨çš„å˜é‡ï¼Œåœ¨éšåçš„playbookä¸­ä½¿ç”¨</p>
<h4 id="-file">ğŸ§© file</h4>
<p>Ansible çš„ <code>file</code> æ¨¡å—ç”¨äºç®¡ç†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å’Œç›®å½•ã€‚å®ƒæä¾›äº†ä¸€äº›å¸¸è§çš„æ–‡ä»¶å’Œç›®å½•æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹æƒé™ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº› <code>file</code> æ¨¡å—çš„å¸¸è§ç”¨æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ansible all -m file -a <span style="color:#e6db74">&#39;path=/tmp/test state=touch mode=&#39;</span>0644<span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>$ ssh centos2 ls -l /tmp/test
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">0</span> Jan <span style="color:#ae81ff">11</span> 02:31 /tmp/test
</span></span></code></pre></div><h4 id="-color">ğŸ§© Color</h4>
<ul>
<li>çº¢è‰²ï¼šå¤±è´¥</li>
<li>é»„è‰²ï¼šæˆåŠŸ ä¸”å˜åŒ–</li>
<li>ç»¿è‰²ï¼šæˆåŠŸ</li>
</ul>
<h4 id="-idempotnce">ğŸ§© Idempotnce</h4>
<p>åœ¨ Ansible ä¸­ï¼Œ&ldquo;Idempotence&rdquo; æ˜¯æŒ‡æ— è®ºä½ è¿è¡Œä¸€ä¸ªä»»åŠ¡å¤šå°‘æ¬¡ï¼Œç³»ç»Ÿçš„çŠ¶æ€éƒ½ä¸ä¼šè¢«æ”¹å˜ã€‚è¿™æ˜¯ Ansible çš„ä¸€ä¸ªæ ¸å¿ƒåŸåˆ™ï¼Œç¡®ä¿åœ¨é‡å¤æ‰§è¡Œä»»åŠ¡æ—¶ä¸ä¼šå¯¼è‡´ä¸å¿…è¦çš„å˜æ›´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>file</code> æ¨¡å—å’Œ <code>copy</code> æ¨¡å—éƒ½æ˜¯å…·æœ‰å¹‚ç­‰æ€§çš„æ¨¡å—ã€‚å½“ä½ ä½¿ç”¨è¿™äº›æ¨¡å—æ¥åˆ›å»ºç›®å½•ã€å¤åˆ¶æ–‡ä»¶ç­‰æ“ä½œæ—¶ï¼ŒAnsible ä¼šæ£€æŸ¥ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ï¼Œåªæœ‰å½“éœ€è¦çš„å˜æ›´å°šæœªå‘ç”Ÿæ—¶æ‰æ‰§è¡Œæ“ä½œï¼Œå¦åˆ™å°†è·³è¿‡ä»»åŠ¡ã€‚ <img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240111104123360.png" alt="image-20240111104123360"
    
    
    />
</p>
<h4 id="-copy">ğŸ§© Copy</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ansible all -m copy -a <span style="color:#e6db74">&#39;src=http://localhost:1313/docsgo/tmp/x dest=/tmp/x&#39;</span>
</span></span></code></pre></div><ul>
<li>&ldquo;checksum&rdquo;: &ldquo;da39a3ee5e6b4b0d3255bfef95601890afd80709&rdquo;, ä¼šæ ¡éªŒæ–‡ä»¶æ˜¯å¦è¢«å¤åˆ¶</li>
</ul>
<p>å‚æ•°ï¼šremote_src=yes ã€ä¾‹ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„/tmp/x æ–‡ä»¶ å¤åˆ¶åˆ° è‡ªå·±çš„/tmp/xxã€‘éå¤åˆ¶æ§åˆ¶èŠ‚ç‚¹</p>
<ul>
<li>æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹äºè¿œç¨‹ä¸»æœºçš„ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äº Ansible æ§åˆ¶èŠ‚ç‚¹</li>
</ul>
<h4 id="-command">ğŸ§© command</h4>
<p>ä¸ä¼šä¼ é€’é‡å®šå‘ç­‰shellå¸¸ç”¨å˜é‡</p>
<h4 id="-fetch">ğŸ§© fetch</h4>
<p><code>fetch</code> æ¨¡å—ç”¨äºä»è¿œç¨‹ä¸»æœºå¤åˆ¶æ–‡ä»¶åˆ° Ansible æ§åˆ¶èŠ‚ç‚¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible all -m file -a <span style="color:#e6db74">&#39;path=/tmp/test_modules.txt state=touch&#39;</span>
</span></span><span style="display:flex;"><span>ansible all -m fetch -a <span style="color:#e6db74">&#39;src=http://localhost:1313/docsgo/tmp/test_modules.txt dest=/tmp/&#39;</span>
</span></span><span style="display:flex;"><span>$ ls /tmp/centos1/tmp/test_modules.txt 
</span></span><span style="display:flex;"><span>/tmp/centos1/tmp/test_modules.txt
</span></span></code></pre></div><h4 id="-ansible-doc">ğŸ§© Ansible-doc</h4>
<h3 id="-ansible-playbook">ğŸ““ Ansible Playbook</h3>
<ul>
<li>Yaml</li>
<li>Playbook æ„æˆã€å˜é‡ã€æ¨¡å—ã€jinja2ã€æ‰§è¡Œ</li>
</ul>
<h4 id="-yaml">â›µï¸ YAML</h4>
<p>show_yaml_python.sh</p>
<pre tabindex="0"><code>python3 -c &#39;import yaml,pprint;pprint.pprint(yaml.load(open(&#34;test.yaml&#34;).read(), Loader=yaml.FullLoader))&#39;
</code></pre><p>Python - Ansible è½¬æ¢</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Every YAML file should start with three dashes</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Every YAML file should end with three dots</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li>å¯ä»¥è¡¨ç¤º YAMLçš„å¼€å§‹å’Œç»“æŸ</li>
</ul>
<p>å…¶ä»–ï¼š</p>
<ol>
<li>å•å¼•å·ã€åŒå¼•å·ã€æœ€ç»ˆéƒ½ä¼šè¢«è§£é‡Šæˆå•å¼•å·</li>
<li>å€¼ä¸ºæ•°å­—ï¼Œæ²¡æœ‰å¼•å· - æ•´æ•°ï¼Œæœ‰å¼•å·-å­—ç¬¦ä¸²</li>
<li>å¤„ç†å¸ƒå°”å€¼éå¸¸å…¨é¢ï¼ˆé™¤äº†yã€nï¼‰</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Introduction/YAML/11$ cat test.yaml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Every YAML file should start with three dashes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- item <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>- item <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>- item <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>- item <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>- item <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Every YAML file should end with three dots</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Introduction/YAML/11$ ./show_yaml_python.sh 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;item 1&#39;</span>, <span style="color:#e6db74">&#39;item 2&#39;</span>, <span style="color:#e6db74">&#39;item 3&#39;</span>, <span style="color:#e6db74">&#39;item 4&#39;</span>, <span style="color:#e6db74">&#39;item 5&#39;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div><ul>
<li>Python åˆ—è¡¨</li>
</ul>
<h4 id="-playbook-1">ğŸ¿ Playbook-1</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAMLæ–‡æ¡£ä»¥æ–‡æ¡£åˆ†éš”ç¬¦---å¼€å¤´</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‡å·åœ¨YAMLä¸­è¡¨ç¤ºä¸€ä¸ªåˆ—è¡¨é¡¹ã€‚PlaybookåŒ…å«ä¸€ç³»åˆ—playsï¼Œæ¯ä¸ªplayéƒ½æ˜¯ä¸€ä¸ªå­—å…¸</span>
</span></span><span style="display:flex;"><span>- 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: æŒ‡å®šplayå°†åœ¨å“ªäº›ä¸»æœºä¸Šè¿è¡Œä»¥åŠå®ƒå°†ä½¿ç”¨çš„é€‰é¡¹</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Vars: åº”ç”¨äºplayçš„å˜é‡ï¼Œä¼šåœ¨æ‰€æœ‰ç›®æ ‡ç³»ç»Ÿä¸Šç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: æ‰§è¡Œåœ¨playä¸­çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ­¤éƒ¨åˆ†ä¹Ÿå¯ç”¨äºå‰åä»»åŠ¡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Handlers: ä»ä»»åŠ¡çš„notifyé”®æ‰§è¡Œçš„å¤„ç†ç¨‹åºåˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Roles: è¦å¯¼å…¥playçš„è§’è‰²åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸‰ä¸ªç‚¹è¡¨ç¤ºYAMLæ–‡æ¡£çš„ç»“å°¾</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>æ‰§è¡Œä¸€ä¸ª playbook</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>ansible.cfg  centos_motd  hosts  motd_playbook.yaml
</span></span></code></pre></div><p><code>motd_playbook.yaml:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">centos</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Vars: variables that will apply to the play, on all target systems</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Configure a MOTD (message of the day)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">src</span>: <span style="color:#ae81ff">centos_motd</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/motd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Handlers: the list of handlers that are executed as a notify key from a task</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Roles: list of roles to be imported into the play</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240112212639216.png" alt="image-20240112212639216"
    
    
    />
</p>
<p>å®šä¹‰å…¶ä»–å‚æ•°ï¼š</p>
<ul>
<li>become</li>
<li>connection</li>
<li>gather_factsï¼šåœ¨ä¸ä½¿ç”¨ä»»ä½• æ”¶é›†ä¿¡æ¯æ—¶ï¼Œå¯ä»¥å…³é—­</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>real    0m1.779s
</span></span><span style="display:flex;"><span>user    0m0.819s
</span></span><span style="display:flex;"><span>sys     0m0.364s
</span></span></code></pre></div><p>å…³é—­gather_factså</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ time ansible-playbook motd_playbook.yaml
</span></span><span style="display:flex;"><span>real    0m0.868s
</span></span><span style="display:flex;"><span>user    0m0.549s
</span></span><span style="display:flex;"><span>sys     0m0.183s
</span></span></code></pre></div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Vars: variables that will apply to the play, on all target systems</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">motd_centos</span>: <span style="color:#e6db74">&#34;Welcome to CentOS Linux - Ansible Rocks\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">motd_ubuntu</span>: <span style="color:#e6db74">&#34;Welcome to Ubuntu Linux - Ansible Rocks\n&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Configure a MOTD (message of the day)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">content</span>: <span style="color:#e6db74">&#34;{{ motd_centos }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/motd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>: <span style="color:#ae81ff">MOTD changed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#34;CentOS&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Configure a MOTD (message of the day)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">content</span>: <span style="color:#e6db74">&#34;{{ motd_ubuntu }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/motd</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>: <span style="color:#ae81ff">MOTD changed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#34;Ubuntu&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Handlers: the list of handlers that are executed as a notify key from a task</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MOTD changed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#ae81ff">The MOTD was changed</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Roles: list of roles to be imported into the play</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li>notifyï¼šå½“ä»»åŠ¡æœ‰å˜åŒ–æ—¶ï¼Œè§¦å‘handlers</li>
</ul>
<p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240112221218695.png" alt="image-20240112221218695"
    
    
    />
</p>
<p><code>ansible_distribution</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ansible all -m setup | grep -w <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;CentOS&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;CentOS&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;CentOS&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;Ubuntu&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;Ubuntu&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;Ubuntu&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ansible_distribution&#34;</span>: <span style="color:#e6db74">&#34;Ubuntu&#34;</span>,
</span></span></code></pre></div><h4 id="-vars">ğŸ«˜ Vars</h4>
<p>å˜é‡ä½œä¸ºç”¨æˆ·è¾“å…¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">vars_prompt</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">username</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">private</span>: <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Test vars_prompt</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ username }}&#34;</span>
</span></span></code></pre></div><p><code>private: False</code>ï¼šè¿™è¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„å€¼ä¸ä¼šè¢«è§†ä¸ºç§å¯†ä¿¡æ¯ï¼Œå³è¾“å…¥çš„å†…å®¹å°†ä¼šè¢«æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>
<p>ä¸»æœºå˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Test hostvars with an ansible fact and collect ansible_port, dot notation, default if not found</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ hostvars[ansible_hostname].ansible_port | default(&#39;22&#39;) }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Test hostvars with an ansible fact and collect ansible_port, dict notation, default if not found</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ hostvars[ansible_hostname][&#39;ansible_port&#39;] | default(&#39;22&#39;) }}&#34;</span>
</span></span></code></pre></div><p>playbook ä¼ å…¥å˜é‡æ–¹å¼</p>
<ul>
<li>ini</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">ansible-playbook variables_playbook.yaml -e extra_vars_key</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;extra vars value&#34;</span>
</span></span></code></pre></div><ul>
<li>json</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ansible-playbook</span> <span style="color:#960050;background-color:#1e0010">variables_playbook.yaml</span> <span style="color:#960050;background-color:#1e0010">-e</span> {<span style="color:#f92672">&#34;extra_vars_key&#34;</span>: <span style="color:#e6db74">&#34;extra vars value&#34;</span>}
</span></span></code></pre></div><ul>
<li>yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">ansible-playbook variables_playbook.yaml -e {extra_vars_key: extra vars value}</span>
</span></span></code></pre></div><h4 id="-playbook-2">ğŸ—ï¸ Playbook-2</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ ansible.cfg
</span></span><span style="display:flex;"><span>â”œâ”€â”€ facts_playbook.yaml
</span></span><span style="display:flex;"><span>â”œâ”€â”€ group_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu
</span></span><span style="display:flex;"><span>â”œâ”€â”€ host_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos1
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu-c
</span></span><span style="display:flex;"><span>â””â”€â”€ hosts
</span></span></code></pre></div><p><code>group_vars</code>ã€<code>host_vars</code> å’Œ <code>hosts</code> æ–‡ä»¶æ˜¯ç”¨æ¥ç»„ç»‡å’Œç®¡ç†å˜é‡çš„æ–¹å¼ï¼Œè¿™æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶å’Œé…ç½®ä¸»æœºå’Œä¸»æœºç»„ã€‚</p>
<ol>
<li><strong><code>group_vars</code>ï¼š</strong>
<ul>
<li>è¿™ä¸ªç›®å½•ä¸­åŒ…å«äº†ç”¨äºæ•´ä¸ªä¸»æœºç»„ï¼ˆä¹Ÿç§°ä¸ºinventory groupï¼‰çš„å˜é‡ã€‚</li>
<li>æ¯ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åå¯¹åº”ä¸€ä¸ªä¸»æœºç»„çš„åå­—ã€‚</li>
<li>è¿™äº›å˜é‡å¯ä»¥è¢«ä¸»æœºç»„å†…çš„æ‰€æœ‰ä¸»æœºæ‰€å…±äº«ã€‚</li>
</ul>
</li>
<li><strong><code>host_vars</code>ï¼š</strong>
<ul>
<li>è¿™ä¸ªç›®å½•ä¸­åŒ…å«äº†ç”¨äºå•ä¸ªä¸»æœºçš„å˜é‡ã€‚</li>
<li>æ¯ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åå¯¹åº”ä¸€ä¸ªä¸»æœºçš„åå­—ã€‚</li>
<li>è¿™äº›å˜é‡åªå¯¹ç‰¹å®šçš„ä¸»æœºç”Ÿæ•ˆã€‚</li>
</ul>
</li>
<li><strong><code>hosts</code> æ–‡ä»¶ï¼š</strong>
<ul>
<li>è¿™æ˜¯ Ansible çš„ inventory æ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†æ‰€æœ‰è¢«ç®¡ç†çš„ä¸»æœºã€‚</li>
<li>åœ¨ <code>hosts</code> æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥å°†ä¸»æœºåˆ†ç»„ï¼Œè¿™äº›ç»„å¯ä»¥å¯¹åº”åˆ° <code>group_vars</code> ä¸­çš„å˜é‡ã€‚</li>
<li>é€šè¿‡åœ¨ <code>hosts</code> æ–‡ä»¶ä¸­å®šä¹‰ä¸»æœºå’Œä¸»æœºç»„ï¼Œæ‚¨å¯ä»¥æœ‰é€‰æ‹©åœ°å°†å˜é‡åº”ç”¨åˆ°ä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„ã€‚</li>
</ul>
</li>
</ol>
<h4 id="-jinja2">ğŸ¨ Jinja2</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ ansible.cfg
</span></span><span style="display:flex;"><span>â”œâ”€â”€ group_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu
</span></span><span style="display:flex;"><span>â”œâ”€â”€ host_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos1
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu-c
</span></span><span style="display:flex;"><span>â”œâ”€â”€ hosts
</span></span><span style="display:flex;"><span>â”œâ”€â”€ jinja2_playbook.yaml
</span></span><span style="display:flex;"><span>â””â”€â”€ template.j2
</span></span></code></pre></div><p><code>jinja2_playbook.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Jinja2 template</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">src</span>: <span style="color:#ae81ff">template.j2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;/tmp/{{ ansible_hostname }}_template.out&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">trim_blocks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">0644</span>
</span></span></code></pre></div><p><code>template.j2</code>:</p>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">--== Ansible Jinja2 if statement ==--

{# If the hostname is ubuntu-c, include a message -#}
{% if ansible_hostname == &#34;ubuntu-c&#34; -%}
      This is ubuntu-c
{% endif %}

--== Ansible Jinja2 if elif statement ==--

{% if ansible_hostname == &#34;ubuntu-c&#34; -%}
   This is ubuntu-c
{% elif ansible_hostname == &#34;centos1&#34; -%}
   This is centos1 with it&#39;s modified SSH Port
{% endif %}

--== Ansible Jinja2 if elif else statement ==--

{% if ansible_hostname == &#34;ubuntu-c&#34; -%}
   This is ubuntu-c
{% elif ansible_hostname == &#34;centos1&#34; -%}
   This is centos1 with it&#39;s modified SSH Port
{% else -%}
   This is good old {{ ansible_hostname }}
{% endif %}

--== Ansible Jinja2 if variable is defined ( where variable is not defined ) ==--

{% if example_variable is defined -%}
   example_variable is defined
{% else -%}
   example_variable is not defined
{% endif %}

--== Ansible Jinja2 if varible is defined ( where variable is defined ) ==--

{% set example_variable = &#39;defined&#39; -%}
{% if example_variable is defined -%}
   example_variable is defined
{% else -%}
   example_variable is not defined
{% endif %}

--== Ansible Jinja2 for statement ==--

{% for entry in ansible_all_ipv4_addresses -%}
   IP Address entry {{ loop.index }} = {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range

{% for entry in range(1, 11) -%}
   {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range, reversed (simulate while greater 5) ==--

{% for entry in range(10, 0, -1) -%}
   {% if entry == 5 -%}
      {% break %}
   {% endif -%}
   {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range, reversed (continue if odd) ==--

{% for entry in range(10, 0, -1) -%}
   {% if entry is odd -%}
      {% continue %}
   {% endif -%}
   {{ entry }}
{% endfor %}

---=== Ansible Jinja2 filters ===---

--== min [1, 2, 3, 4, 5] ==--

{{ [1, 2, 3, 4, 5] | min }}

--== max [1, 2, 3, 4, 5] ==--

{{ [1, 2, 3, 4, 5] | max }}

--== unique [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] ==--

{{ [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] | unique }}

--== difference [1, 2, 3, 4, 5] vs [2, 3, 4] ==--

{{ [1, 2, 3, 4, 5] | difference([2, 3, 4]) }}

--== random [&#39;rod&#39;, &#39;jane&#39;, &#39;freddy&#39;] ==--

{{ [&#39;rod&#39;, &#39;jane&#39;, &#39;freddy&#39;] | random }}

--== urlsplit hostname ==--

{{ &#34;http://docs.ansible.com/ansible/latest/playbooks_filters.html&#34; | urlsplit(&#39;hostname&#39;) }}
</code></pre><h4 id="playbook-åˆ›å»ºå’Œæ‰§è¡Œ">Playbook åˆ›å»ºå’Œæ‰§è¡Œ</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ ansible.cfg
</span></span><span style="display:flex;"><span>â”œâ”€â”€ files
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ playbook_stacker.zip
</span></span><span style="display:flex;"><span>â”œâ”€â”€ group_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu
</span></span><span style="display:flex;"><span>â”œâ”€â”€ host_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos1
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu-c
</span></span><span style="display:flex;"><span>â”œâ”€â”€ hosts
</span></span><span style="display:flex;"><span>â”œâ”€â”€ nginx_playbook.yaml
</span></span><span style="display:flex;"><span>â”œâ”€â”€ templates
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ index.html-ansible_managed.j2
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ index.html-base.j2
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ index.html-easter_egg.j2
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ index.html-logos.j2
</span></span><span style="display:flex;"><span>â””â”€â”€ vars
</span></span><span style="display:flex;"><span>    â””â”€â”€ logos.yaml
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240116122759223.png" alt="image-20240116122759223"
    
    
    />
</p>
<p><code>nginx_playbook.yamlæ–‡ä»¶ï¼š</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Vars: variables that will apply to the play, on all target systems</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars_files</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">vars/logos.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install EPEL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">update_cache</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#39;CentOS&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install Nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">package</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Restart nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">restarted</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>: <span style="color:#ae81ff">Check HTTP Service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Template index.html-easter_egg.j2 to index.html on target</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">src</span>: <span style="color:#ae81ff">index.html-easter_egg.j2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;{{ nginx_root_location }}/index.html&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">0644</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install unzip</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">package</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">unzip</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Unarchive playbook stacker game</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">unarchive</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">src</span>: <span style="color:#ae81ff">playbook_stacker.zip</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;{{ nginx_root_location }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">0755</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Handlers: the list of handlers that are executed as a notify key from a task</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Check HTTP Service</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uri</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://{{ ansible_default_ipv4.address }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">status_code</span>: <span style="color:#ae81ff">200</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h3 id="-ansible-playbook-æ·±å…¥">ğŸš€ Ansible Playbook æ·±å…¥</h3>
<ul>
<li>Ansible Playbook æ¨¡å—</li>
<li>åŠ¨æ€æ¸…å•æ–‡ä»¶</li>
<li>æ‰§è¡Œä»»åŠ¡æ—¶æ”¶åˆ°çš„ä¿¡æ¯ï¼Œåœ¨ä¹‹ååˆ©ç”¨</li>
<li>å¾ªç¯</li>
<li>æ€§èƒ½ç ”ç©¶ï¼ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œï¼‰</li>
<li>ä»»åŠ¡å§”æ‰˜</li>
<li>Ansible å˜é‡ï¼ˆç‰¹æ®Šçš„ä¸€ç»„ï¼‰</li>
<li>å— - blocks</li>
<li>ä¿¡æ¯ä¿æŠ¤ - vault</li>
</ul>
<h4 id="ansible-playbook-æ¨¡å—">Ansible Playbook æ¨¡å—</h4>
<p>ä¸Šåƒç§æ¨¡å—</p>
<h5 id="set_fact">set_fact</h5>
<p>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å…è®¸åŠ¨æ€çš„æ”¹å˜æˆ–æ·»åŠ äº‹å®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">ubuntu3,centos3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set a fact</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">set_fact</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">our_fact</span>: <span style="color:#ae81ff">Ansible Rocks!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Show custom fact</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ our_fact }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240116125011843.png" alt="image-20240116125011843"
    
    
    />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">ubuntu3,centos3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set our installation variables for CentOS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">set_fact</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_path</span>: <span style="color:#ae81ff">/usr/share/nginx/html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_user</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#39;CentOS&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set our installation variables for Ubuntu</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">set_fact</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_path</span>: <span style="color:#ae81ff">/var/www/html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">webserver_application_user</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#39;Ubuntu&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Show pre-set distribution based facts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;webserver_application_port:{{ webserver_application_port }} webserver_application_path:{{ webserver_application_path }} webserver_application_user:{{ webserver_application_user }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="pause">pause</h5>
<p><a href="https://docs.ansible.com/ansible/2.9/modules/pause_module.html#pause-module">https://docs.ansible.com/ansible/2.9/modules/pause_module.html#pause-module</a></p>
<ul>
<li>å°† playbook æ‰§è¡Œæš‚åœä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç›´åˆ°ç¡®è®¤æç¤ºä¸ºæ­¢ã€‚æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¯é€‰çš„ã€‚é»˜è®¤è¡Œä¸ºæ˜¯æš‚åœå¹¶å‡ºç°æç¤ºã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># æš‚åœ 10 s</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Pause our playbook for 10 seconds</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pause</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">seconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æç¤ºä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Prompt user to verify before continue</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">pause</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prompt</span>: <span style="color:#ae81ff">Please check that the webserver is running, press enter to continue</span>
</span></span></code></pre></div><h5 id="wait_for">wait_for</h5>
<p>â€“ åœ¨ç»§ç»­ä¹‹å‰ç­‰å¾…æ¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 80ç«¯å£æ˜¯å¦running</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Wait for the webserver to be running on port 80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">wait_for</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h5 id="add_host">add_host</h5>
<p>add_host â€“ å°†ä¸»æœºï¼ˆæˆ–è€…ç»„ï¼‰æ·»åŠ åˆ° ansible-playbook å†…å­˜æ¸…å•ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat add_host_playbook.yaml </span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">ubuntu-c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add centos1 to adhoc_group</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">add_host</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">centos1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">groups</span>: <span style="color:#ae81ff">adhoc_group1, adhoc_group2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">adhoc_group1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Ping all in adhoc_group1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="group_by">group_by</h5>
<ul>
<li>ä½¿ç”¨äº‹å®åˆ›å»ºä¸´æ—¶ç»„ï¼Œä»¥ä¾¿ç¨ååœ¨å‰§æœ¬ä¸­ä½¿ç”¨ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat group_by_playbook.yaml </span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create group based on ansible_distribution</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group_by</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;custom_{{ ansible_distribution | lower }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">custom_centos</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Ping all in custom_centos</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ping</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="fetch">fetch</h5>
<ul>
<li>ä»è¿œç¨‹èŠ‚ç‚¹è·å–æ–‡ä»¶</li>
</ul>
<ul>
<li>è¯¥æ¨¡å—çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº<a href="https://docs.ansible.com/ansible/2.9/modules/copy_module.html#copy-module">copy</a>ï¼Œä½†æ–¹å‘ç›¸åã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Store file into /tmp/fetched/host.example.com/tmp/somefile</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/somefile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp/fetched</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Specifying a path directly</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/somefile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp/prefix-{{ inventory_hostname }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">flat</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Specifying a destination path</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/uniquefile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/tmp/special/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">flat</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Storing in a path relative to the playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fetch</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/uniquefile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">special/prefix-{{ inventory_hostname }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">flat</span>: <span style="color:#66d9ef">yes</span>
</span></span></code></pre></div><h4 id="åŠ¨æ€æ¸…å•æ–‡ä»¶">åŠ¨æ€æ¸…å•æ–‡ä»¶</h4>
<p>ç”¨æœ€å°çš„è„šæœ¬åˆ›å»ºåŠ¨æ€æ¸…å•æ–‡ä»¶ã€æŸ¥è¯¢ã€ä½¿ç”¨_meta æ€§èƒ½æå‡ã€ä½¿ç”¨ansible_palybook æ¡†æ¶</p>
<p>åˆ°ç›®å‰ï¼Œä¸€ç›´ä½¿ç”¨çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ ansible.cfg
</span></span><span style="display:flex;"><span>â”œâ”€â”€ fetch_playbook.yaml
</span></span><span style="display:flex;"><span>â”œâ”€â”€ group_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu
</span></span><span style="display:flex;"><span>â”œâ”€â”€ host_vars
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ centos1
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ ubuntu-c
</span></span><span style="display:flex;"><span>â””â”€â”€ hosts
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ -i æŒ‡å®šæ¸…å•æ–‡ä»¶</p>
<p><code>$ cat inventory.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Dynamic inventory for Ansible in Python
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use print functionality from Python 3 for compatibility</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Attempt to import json, if it fails, import simplejson</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> simplejson <span style="color:#66d9ef">as</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Inherit from object for Python 2/3 compatibility</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Inventory</span>(object):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Constructor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, include_hostvars_in_list):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Configure logger</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#self.configure_logger()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Capture and store include_hostvars_in_list</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>include_hostvars_in_list <span style="color:#f92672">=</span> include_hostvars_in_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Capture the script command line arguments</span>
</span></span><span style="display:flex;"><span>        parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--list&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>,
</span></span><span style="display:flex;"><span>                            help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;list inventory&#39;</span>)
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--host&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store&#39;</span>,
</span></span><span style="display:flex;"><span>                            help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;show HOST variables&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If not called with --host or --list, show usage and exit</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>list <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>host):
</span></span><span style="display:flex;"><span>            parser<span style="color:#f92672">.</span>print_usage()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Capture and store the inventory</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>define_inventory()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># When called with --list, print the inventory</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>list:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>print_json(self<span style="color:#f92672">.</span>list())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If called with --host, print host information</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>host:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>print_json(self<span style="color:#f92672">.</span>host())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">define_inventory</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>groups <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;centos&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;hosts&#34;</span>: [<span style="color:#e6db74">&#34;centos1&#34;</span>, <span style="color:#e6db74">&#34;centos2&#34;</span>, <span style="color:#e6db74">&#34;centos3&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;vars&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;ansible_user&#34;</span>: <span style="color:#e6db74">&#39;root&#39;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;control&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;hosts&#34;</span>: [<span style="color:#e6db74">&#34;ubuntu-c&#34;</span>],
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ubuntu&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;hosts&#34;</span>: [<span style="color:#e6db74">&#34;ubuntu1&#34;</span>, <span style="color:#e6db74">&#34;ubuntu2&#34;</span>, <span style="color:#e6db74">&#34;ubuntu3&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;vars&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;ansible_become&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;ansible_become_pass&#34;</span>: <span style="color:#e6db74">&#39;password&#39;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;linux&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;children&#34;</span>: [<span style="color:#e6db74">&#34;centos&#34;</span>, <span style="color:#e6db74">&#34;ubuntu&#34;</span>],
</span></span><span style="display:flex;"><span>            }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>hostvars <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;centos1&#39;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;ansible_port&#39;</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ubuntu-c&#39;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;ansible_connection&#39;</span>: <span style="color:#e6db74">&#39;local&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Pretty print JSON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_json</span>(self, content):
</span></span><span style="display:flex;"><span>        print(json<span style="color:#f92672">.</span>dumps(content, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, sort_keys<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return inventory dictionary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#self.logger.info(&#39;list executed&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If include_hostvars_in_list is True, merge the hostvars</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># as _meta data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>include_hostvars_in_list:
</span></span><span style="display:flex;"><span>            merged <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>groups
</span></span><span style="display:flex;"><span>            merged[<span style="color:#e6db74">&#39;_meta&#39;</span>] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>            merged[<span style="color:#e6db74">&#39;_meta&#39;</span>][<span style="color:#e6db74">&#39;hostvars&#39;</span>] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>hostvars
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> merged
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, return the groups without hostvars</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>groups
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return host dictionary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">host</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#self.logger.info(&#39;host executed for {}&#39;.format(self.args.host))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If the requested hosts exists in hostvars, return it</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>host <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>hostvars:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>hostvars[self<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>host]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, return an empty list</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Logger, for debugging as stdout is used by the script</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">configure_logger</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;ansible_dynamic_inventory&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>hdlr <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>FileHandler(<span style="color:#e6db74">&#39;/var/tmp/ansible_dynamic_inventory.log&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>formatter <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>Formatter(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>hdlr<span style="color:#f92672">.</span>setFormatter(self<span style="color:#f92672">.</span>formatter)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>addHandler(self<span style="color:#f92672">.</span>hdlr) 
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>DEBUG)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Call the Inventory class constructor (__init__)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pass include_hostsvars_in_list as True to include hostvars</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># as _meta data in list output</span>
</span></span><span style="display:flex;"><span>Inventory(include_hostvars_in_list<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p><img
    src="../../../../../devops_notes/ansible/images/ansible/image-20240116223851739.png" alt="image-20240116223851739"
    
    
    />
</p>
<h4 id="æ³¨å†Œå’Œè¾“å‡º">æ³¨å†Œå’Œè¾“å‡º</h4>
<ul>
<li>å¦‚ä½•åˆ©ç”¨æ³¨å†Œè¾“å‡ºã€è§£å†³å·®å¼‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">hostname_output</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Show hostname_output</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">var</span>: <span style="color:#ae81ff">hostname_output.stdout</span>
</span></span></code></pre></div><p>when</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ansible_distribution == &#34;CentOS&#34; and ansible_distribution_major_version == &#34;8&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">( ansible_distribution == &#34;CentOS&#34; and ansible_distribution_major_version == &#34;8&#34; ) or</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">( ansible_distribution == &#34;Ubuntu&#34; and ansible_distribution_major_version == &#34;20&#34; )</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">( ansible_distribution == &#34;CentOS&#34; and ansible_distribution_major_version | int &gt;= 8 ) or</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">( ansible_distribution == &#34;Ubuntu&#34; and ansible_distribution_major_version | int &gt;= 20 )</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: 
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution == &#34;CentOS&#34; </span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution_major_version | int &gt;= 8</span>
</span></span></code></pre></div><p>register_when_playbook.yaml :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: 
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution == &#34;CentOS&#34; </span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution_major_version | int &gt;= 8</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">command_register</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install patch when changed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">command_register.changed</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Exploring register</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">hostname -s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution == &#34;CentOS&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ansible_distribution_major_version | int &gt;= 8</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">command_register</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bug</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#34;{{ command_register }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install patch when changed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">command_register is changed</span>
</span></span></code></pre></div><hr>
<h4 id="ansible-æ€§èƒ½é—®é¢˜">Ansible æ€§èƒ½é—®é¢˜</h4>
<p>é€šè¿‡å†…ç½®åŠŸèƒ½æå‡</p>
<ul>
<li>æ€§èƒ½ å’Œ ç“¶é¢ˆ é—®é¢˜</li>
<li>è½®è¯¢</li>
<li>å¼‚æ­¥ã€å¼‚æ­¥çŠ¶æ€å¤„ç†</li>
<li>ä¸²è¡Œæ‰§è¡Œ</li>
<li>æ‰¹é‡æ‰§è¡Œ</li>
</ul>
<p>Using Include and Import</p>
<ol>
<li>Include_tasks</li>
<li>import_tasks</li>
</ol>
<p>æ‰§è¡Œç»“æœå¾ˆåƒï¼Œæœ€å¤§åŒºåˆ«ï¼šimport é¢„å¤„ç†ï¼Œinclude æ‰§è¡Œé‡åˆ°æ—¶å¤„ç†ï¼Œä½¿ç”¨ when æ—¶æ›´æ˜æ˜¾</p>
<p><a href="https://github.com/spurin/diveintoansible/blob/master/Structuring%20Ansible%20Playbooks/Using%20Include%20and%20Import/03/include_import_tasks_playbook.yaml">https://github.com/spurin/diveintoansible/blob/master/Structuring%20Ansible%20Playbooks/Using%20Include%20and%20Import/03/include_import_tasks_playbook.yaml</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YAML documents begin with the document separator ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The minus in YAML this indicates a list item.  The playbook contains a list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># of plays, with each play being a dictionary</span>
</span></span><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Hosts: where our play will run and options it will run with</span>
</span></span><span style="display:flex;"><span>  hosts: centos1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Tasks: the list of tasks that will be executed within the play, this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># can also be used for pre and post tasks</span>
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     - debug:
</span></span><span style="display:flex;"><span>         msg: <span style="color:#f92672">=====================</span> Testing include_tasks <span style="color:#f92672">=====================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># include_tasks is dynamic</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># The when statement is executed once, if the condition is met, all</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># tasks are executed</span>
</span></span><span style="display:flex;"><span>     - include_tasks: include_tasks.yaml
</span></span><span style="display:flex;"><span>       when: include_tasks_var is not defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     - debug:
</span></span><span style="display:flex;"><span>         msg: <span style="color:#f92672">=====================</span> Testing import_tasks <span style="color:#f92672">======================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># import_tasks is static</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># Each task that in the include will be independently executed against</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># the when condition</span>
</span></span><span style="display:flex;"><span>     - import_tasks: import_tasks.yaml
</span></span><span style="display:flex;"><span>       when: import_tasks_var is not defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Three dots indicate the end of a YAML document</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h4 id="tags">Tags</h4>
<p>ä½¿ç”¨æ ‡ç­¾è¿›è¡Œç»†åˆ†</p>
<p>é»˜è®¤æƒ…å†µä¸‹æ˜¯<code>--tags &quot;all&quot;</code></p>
<p>1.ä¸å¸Œæœ›æ‰§è¡Œæ•´ä¸ªå‰§æœ¬æ—¶éå¸¸æœ‰ç”¨</p>
<pre tabindex="0"><code>--tags &#34;&#34;
</code></pre><p>2.åä¹‹è·³è¿‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>--skips-tags <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>3.è®¾ç½®æ ‡ç­¾ç”¨äºæ•´ä¸ª playbook</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>-
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">hosts linux</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">web</span>
</span></span></code></pre></div><ul>
<li>è¿™æ ·å†æŒ‡å®šå…¶ä¸­çš„ tasks ä¸­çš„ tags æ—¶ ä¼šè·³è¿‡ Facts</li>
</ul>
<p>4.æ€»æ˜¯è¿è¡Œã€å¯ä»¥ä½¿ç”¨&ndash;skips-tags è·³è¿‡ã€‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">always</span>
</span></span></code></pre></div><h4 id="roles">Roles</h4>
<p>è§’è‰²çš„æœ¬è´¨æ˜¯ç›®å½•ç»“æ„</p>
<p>ansible-galaxy æŒºæ¾åˆ›å»ºç›®å½•æ¶æ„</p>

        </div>
    </div>
</div>
