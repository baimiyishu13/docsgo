
<script src="/docsgo/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=docsgo/livereload" data-no-instant defer></script><div class="footer-content ">
    <div class="row" style="display: flex; justify-content: center; align-items: center;">

        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img class="float-right" src="http://localhost:1313/docsgo/punching.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
        <div class="col-md-6 col-md-offset-1 vcenter">
            <div class="quote" style="font-size: 1.5em; font-family: 'Courier New', Courier, monospace; color: #888; margin-left: 20px; margin-right: 20px; text-align: center;">“成功绝非偶然。 这是努力工作、坚持不懈、学习、学习、牺牲，最重要的是，热爱你正在做的事情或正在学习的事情。” - 贝利</div>
        </div>
        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img src="http://localhost:1313/docsgo/success.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
    </div>
</div>
<div id="article" style="padding-left: 20px; padding-right: 20px;">
    <div class="article-title">
        <h1>第5章：生产环境中的管道</h1>
    </div>
    
    
    <time datetime="2024-04-23T15:42:55&#43;08:00">April 23, 2024</time>
    <hr/>
    <aside>
        <p> 目录: </p>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#第一步单元测试">第一步：单元测试</a></li>
    <li><a href="#第二步镜像">第二步：镜像</a></li>
    <li><a href="#3部署到-dev-server">3、部署到 Dev Server</a>
      <ul>
        <li><a href="#1部署">1、部署</a></li>
        <li><a href="#2部署环境">2、部署环境</a></li>
        <li><a href="#3docker-compose">3、Docker-compose</a></li>
      </ul>
    </li>
    <li><a href="#4增加阶段">4、增加阶段</a></li>
  </ul>
</nav>
    </aside>
    <hr>
    <div class="post">
        <div id="content-font">
            <p>将构建打包应用程序，构建镜像打包部署到环境</p>
<p>使用项目：https://gitlab.com/baimiyishu13/mynodeapp-cicd-project，构建一个完整的 cicd 管道</p>
<p>具体有以下步骤：</p>
<ol>
<li>单元测试</li>
<li>STAT 应用程序安全测试，扫描代码安全</li>
<li>docker build</li>
<li>docker push Registry</li>
<li>deploy -DEV</li>
<li>deploy -test</li>
<li>deploy-生产</li>
</ol>
<hr>
<h2 id="第一步单元测试">第一步：单元测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">workflow</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">if</span>: <span style="color:#ae81ff">$CI_COMMIT_BRANCH != &#34;main&#34; &amp;&amp; $CI_PIPELINE_SOURCE != &#34;merge_request_event&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">never</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">run_unit_test</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">image</span>: <span style="color:#ae81ff">node:21-alpine</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">docker</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">cd app</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">npm install</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">npm test</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">artifacts</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">reports</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">junit</span>: <span style="color:#ae81ff">app/junit.xml</span>
</span></span></code></pre></div><p>解释：</p>
<ul>
<li>artifacts 关键字用于指定在 job 运行后需要保存的文件或目录</li>
<li>path: app/junit.xml 指定了需要保存的文件或目录的路径</li>
<li>reports 是一个映射，它的键是报告类型，值是报告文件的路径
<ul>
<li>junit: app/junit.xml 指定了生成的 JUnit 测试报告的路径</li>
</ul>
</li>
</ul>
<p>报告必须是 xml</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423170335882.png" alt="image-20240423170335882"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>测试报告</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423170459380.png" alt="image-20240423170459380"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>下载报告：</p>
<ul>
<li>paths 参数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>   <span style="color:#f92672">artifacts</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">reports</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">junit</span>: <span style="color:#ae81ff">app/junit.xml</span>
</span></span></code></pre></div><p><img
    src="http://localhost:1313/docsgo/images/image-20240423171509168.png" alt="image-20240423171509168"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>测试失败：</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423172003356.png" alt="image-20240423172003356"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>如果开发人员想重一些东西：</p>
<p>如果不小心删除了 Dockerfile, 然后创建合并</p>
<p>这一步测试将会失败：</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423172506995.png" alt="image-20240423172506995"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423173312957.png" alt="image-20240423173312957"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<h2 id="第二步镜像">第二步：镜像</h2>
<p>构建</p>
<p>push</p>
<p>github 实际上为每个项目提供了一个内置的 docker registry</p>
<p>位置：gitlab - 部署 - 容器镜像库</p>
<p>push/pull 镜像，需要 login 认证凭证</p>
<p>每个项目都有自己的 docker registry</p>
<p>访问 /var/run/docker.sock 权限不足</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo usermod -aG docker gitlab-runner
</span></span><span style="display:flex;"><span>gitlab-runner restart
</span></span></code></pre></div><ul>
<li>CI_REGISTRY</li>
<li>CI_REGISTRY_IMAGE</li>
<li>CI_REGISTRY_PASSWORD</li>
<li>CI_REGISTRY_USER</li>
</ul>
<p>这些值都是gitlab 注入的变量，不必重复</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">build_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker build -t registry.gitlab.com/baimiyishu13/mynodeapp-cicd-project:1.0 .</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># - docker build -t $CI_REGISTRY_IMAGE:1.0 .</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">push_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">build_image</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REPOSITORY_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push registry.gitlab.com/baimiyishu13/mynodeapp-cicd-project:1.0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># - docker push $CI_REGISTRY_IMAGE:1.0</span>
</span></span></code></pre></div><p><img
    src="http://localhost:1313/docsgo/images/image-20240423223746145.png" alt="image-20240423223746145"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423223801905.png" alt="image-20240423223801905"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>完整配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#66d9ef">if</span>: $CI_COMMIT_BRANCH !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;main&#34;</span> <span style="color:#f92672">&amp;&amp;</span> $CI_PIPELINE_SOURCE !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;merge_request_event&#34;</span>
</span></span><span style="display:flex;"><span>      when: never
</span></span><span style="display:flex;"><span>    - when: always
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>  - test
</span></span><span style="display:flex;"><span>  - build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>  GIT_DEPTH: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run_unit_test:
</span></span><span style="display:flex;"><span>   image: node:21-alpine
</span></span><span style="display:flex;"><span>   stage: test
</span></span><span style="display:flex;"><span>   tags:
</span></span><span style="display:flex;"><span>     - ec2
</span></span><span style="display:flex;"><span>     - aws
</span></span><span style="display:flex;"><span>     - docker
</span></span><span style="display:flex;"><span>   before_script:
</span></span><span style="display:flex;"><span>     - cd app
</span></span><span style="display:flex;"><span>     - npm install
</span></span><span style="display:flex;"><span>   script:
</span></span><span style="display:flex;"><span>     - npm test
</span></span><span style="display:flex;"><span>   artifacts:
</span></span><span style="display:flex;"><span>     when: always
</span></span><span style="display:flex;"><span>     paths:
</span></span><span style="display:flex;"><span>     - app/junit.xml
</span></span><span style="display:flex;"><span>     reports:
</span></span><span style="display:flex;"><span>       junit: app/junit.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build_image:
</span></span><span style="display:flex;"><span>  stage: build
</span></span><span style="display:flex;"><span>  tags:
</span></span><span style="display:flex;"><span>    - ec2
</span></span><span style="display:flex;"><span>    - aws
</span></span><span style="display:flex;"><span>    - shell
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - echo $CI_REGISTRY_IMAGE
</span></span><span style="display:flex;"><span>    - docker build -t $CI_REGISTRY_IMAGE:1.2 .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>push_image:
</span></span><span style="display:flex;"><span>  stage: build
</span></span><span style="display:flex;"><span>  needs:
</span></span><span style="display:flex;"><span>    - build_image
</span></span><span style="display:flex;"><span>  tags:
</span></span><span style="display:flex;"><span>    - ec2
</span></span><span style="display:flex;"><span>    - aws
</span></span><span style="display:flex;"><span>    - shell
</span></span><span style="display:flex;"><span>  before_script:
</span></span><span style="display:flex;"><span>    - echo $CI_REGISTRY_USER
</span></span><span style="display:flex;"><span>    - echo $CI_REGISTRY_PASSWORD
</span></span><span style="display:flex;"><span>    - echo $CI_REGISTRY
</span></span><span style="display:flex;"><span>    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - echo $CI_REGISTRY_IMAGE
</span></span><span style="display:flex;"><span>    - docker push $CI_REGISTRY_IMAGE:1.2
</span></span></code></pre></div><p>当然，如果希望镜像是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>registry.gitlab.com/baimiyishu13/mynodeapp-cicd-project/microervice/pyment:1.2
</span></span></code></pre></div><p>修改</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ae81ff">docker build -t  $CI_REGISTRY_IMAGE/microservice/payment:1.2 .</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">docker push  $CI_REGISTRY_IMAGE/microservice/payment:1.2</span>
</span></span></code></pre></div><p>灵活使用：</p>
<p>也可以在此添加变量，比如镜像名称：或者在CI设置中添加变量</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423231321712.png" alt="image-20240423231321712"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>还可以：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">GIT_DEPTH</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_NAME</span>: <span style="color:#ae81ff">$CI_REGISTRY_IMAGE/microservice/payment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_TAG</span>: <span style="color:#e6db74">&#34;1.2&#34;</span>
</span></span></code></pre></div><h2 id="3部署到-dev-server">3、部署到 Dev Server</h2>
<h3 id="1部署">1、部署</h3>
<p>下载 服务器的 ~/.ssh/key.pem   文件</p>
<p>测试登陆：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ssh -i key.pem root@1.15.176.240
</span></span></code></pre></div><p>如果登陆使用的不是root，那么将docker 命令加入 用户组</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo usermod -aG docker ubuntu
</span></span></code></pre></div><p>向gitlab 提供 ssh 私钥</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240423233633105.png" alt="image-20240423233633105"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ssh -o StrictHostKeyChecking<span style="color:#f92672">=</span>no -i $SSH_PRIVATE_KEY root@$DEV_SERVER_HOST
</span></span></code></pre></div><ul>
<li>-o StrictHostKeyChecking=no  禁用密钥严格检查</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">workflow</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">if</span>: <span style="color:#ae81ff">$CI_COMMIT_BRANCH != &#34;main&#34; &amp;&amp; $CI_PIPELINE_SOURCE != &#34;merge_request_event&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">never</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">GIT_DEPTH</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_NAME</span>: <span style="color:#ae81ff">$CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_TAG</span>: <span style="color:#e6db74">&#34;1.3&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DEV_SERVER_HOST</span>: <span style="color:#e6db74">&#34;1.15.176.240&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">run_unit_test</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">node:21-alpine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cd app</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">npm install</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">npm test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">artifacts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">reports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">junit</span>: <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">build_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker build -t $IMAGE_NAME:$IMAGE_TAG .</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">push_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">build_image</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_USER</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_PASSWORD</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push $IMAGE_NAME:$IMAGE_TAG</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">deploy_to_dev</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">chmod 600 $SSH_PRIVATE_KEY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ssh -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY root@$DEV_SERVER_HOST &#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker run -d -p 3001:3000 $IMAGE_NAME:$IMAGE_TAG&#34;</span>
</span></span></code></pre></div><p><img
    src="http://localhost:1313/docsgo/images/image-20240424110032705.png" alt="image-20240424110032705"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240424110218929.png" alt="image-20240424110218929"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<h3 id="2部署环境">2、部署环境</h3>
<p>当这个 任务成功运行后，GitLab CI/CD 就会知道你的应用已经被部署到了哪里，然后它可以在 GitLab 的界面上显示一个到你的应用的链接。</p>
<ul>
<li>name 是环境的名称</li>
<li>url 是这个环境的公开可访问的 URL</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">GIT_DEPTH</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_NAME</span>: <span style="color:#ae81ff">$CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_TAG</span>: <span style="color:#e6db74">&#34;1.3&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DEV_SERVER_HOST</span>: <span style="color:#e6db74">&#34;1.15.176.240&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DEV_ENDPOINT</span>: <span style="color:#ae81ff">http://$DEV_SERVER_HOST:3001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">deploy_to_dev</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">chmod 600 $SSH_PRIVATE_KEY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ssh -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY root@$DEV_SERVER_HOST &#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker run -d -p 3001:3000 $IMAGE_NAME:$IMAGE_TAG&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">development</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">$DEV_ENDPOINT</span>
</span></span></code></pre></div><p><img
    src="http://localhost:1313/docsgo/images/image-20240424112350919.png" alt="image-20240424112350919"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240424112458685.png" alt="image-20240424112458685"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<h3 id="3docker-compose">3、Docker-compose</h3>
<p>如果再次运行一个版本，会报错端口占用导致管道失败。</p>
<p>使用 docker-compose 而不是一直去 docker run</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">${IMAGE_NAME}:${IMAGE_TAG}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">${APP_PORT}:3000</span>
</span></span></code></pre></div><p>注意：管道中 exporter</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">workflow</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">if</span>: <span style="color:#ae81ff">$CI_COMMIT_BRANCH != &#34;main&#34; &amp;&amp; $CI_PIPELINE_SOURCE != &#34;merge_request_event&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">never</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">GIT_DEPTH</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_NAME</span>: <span style="color:#ae81ff">$CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">IMAGE_TAG</span>: <span style="color:#e6db74">&#34;1.2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">APP_PORT</span>: <span style="color:#ae81ff">3001</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DEV_SERVER_HOST</span>: <span style="color:#e6db74">&#34;1.15.176.240&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">DEV_ENDPOINT</span>: <span style="color:#ae81ff">http://$DEV_SERVER_HOST:3001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">run_unit_test</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">node:21-alpine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cd app</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">npm install</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">npm test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">artifacts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">reports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">junit</span>: <span style="color:#ae81ff">app/junit.xml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">build_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker build -t $IMAGE_NAME:$IMAGE_TAG .</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">push_image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">build_image</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_USER</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_PASSWORD</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">echo $CI_REGISTRY_IMAGE</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">docker push $IMAGE_NAME:$IMAGE_TAG</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">deploy_to_dev</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ec2</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">before_script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">chmod 600 $SSH_PRIVATE_KEY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">scp -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY ./docker-compose.yaml root@$DEV_SERVER_HOST:/root</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ssh -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY root@$DEV_SERVER_HOST &#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">export IMAGE_NAME=$IMAGE_NAME &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">export IMAGE_TAG=$IMAGE_TAG &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">export APP_PORT=$APP_PORT &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker-compose down &amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">docker-compose up -d &#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">development</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">$DEV_ENDPOINT</span>
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><h2 id="4增加阶段">4、增加阶段</h2>
<p><img
    src="http://localhost:1313/docsgo/images/image-20240424141203635.png" alt="image-20240424141203635"
    
     style="width: 50%; max-width: Title;"
    />
</p>
<p>当前阶段</p>
<p>新增：</p>
<ol>
<li>yamlline</li>
<li>static 安全分析测试</li>
<li>等</li>
</ol>

        </div>
    </div>
</div>
