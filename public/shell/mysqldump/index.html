
<script src="/docsgo/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=docsgo/livereload" data-no-instant defer></script><div class="footer-content ">
    <div class="row" style="display: flex; justify-content: center; align-items: center;">

        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img class="float-right" src="http://localhost:1313/docsgo/punching.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
        <div class="col-md-6 col-md-offset-1 vcenter">
            <div class="quote" style="font-size: 1.5em; font-family: 'Courier New', Courier, monospace; color: #888; margin-left: 20px; margin-right: 20px; text-align: center;">â€œæˆåŠŸç»éå¶ç„¶ã€‚ è¿™æ˜¯åŠªåŠ›å·¥ä½œã€åšæŒä¸æ‡ˆã€å­¦ä¹ ã€å­¦ä¹ ã€ç‰ºç‰²ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œçƒ­çˆ±ä½ æ­£åœ¨åšçš„äº‹æƒ…æˆ–æ­£åœ¨å­¦ä¹ çš„äº‹æƒ…ã€‚â€ - è´åˆ©</div>
        </div>
        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img src="http://localhost:1313/docsgo/success.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
    </div>
</div>
<div id="article" style="padding-left: 20px; padding-right: 20px;">
    <div class="article-title">
        <h1>Mysqldump</h1>
    </div>
    
    
    <time datetime="2024-03-28T16:11:37&#43;08:00">March 28, 2024</time>
    <hr/>
    <aside>
        <p> ç›®å½•: </p>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#-mysqldump">ğŸ­ mysqldump</a></li>
  </ul>
</nav>
    </aside>
    <hr>
    <div class="post">
        <div id="content-font">
            <h2 id="-mysqldump">ğŸ­ mysqldump</h2>
<p>âœ… æ‰§è¡Œ mysqldump.sh å®Œæˆå…¨é‡å¤‡ä»½ å˜é‡ (å¿…é¡»):</p>
<ol>
<li>BACKUP_DIRï¼šå¤‡ä»½ç›®å½•</li>
<li>MYSQL_UNAMEï¼šç”¨æˆ·</li>
<li>MYSQL_PWORDï¼šå¯†ç </li>
<li>PATHï¼šmysqldumpå‘½ä»¤è·¯å¾„</li>
<li>KEEP_BACKUPS_FORï¼šä¿ç•™å¤©æ•°(é»˜è®¤7å¤©)</li>
</ol>
<p>ğŸŒ æ¢å¤(ç¤ºä¾‹)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> file in ./2024-03-07/*.sql.gz; <span style="color:#66d9ef">do</span> gunzip &gt; <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> | mysql -u your_username -p your_database_name; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>â›³ï¸ cron(ç¤ºä¾‹)</p>
<p>ä¾‹ï¼šæ¯å¤©å®šæ—¶å‡Œæ™¨1ç‚¹10åˆ†å¤‡ä»½æ•°æ®åº“</p>
<pre tabindex="0"><code>10 1 * * * /bin/bash /data/mysql/.sh/mysql_backup.sh
</code></pre><p>è„šæœ¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#TITLE:            mysql_backup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#DESCRIPTION:      è‡ªåŠ¨æ‰§è¡Œæ—¥å¸¸ mysql å¤‡ä»½çš„è„šæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#DATE:             2024.03.07</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#VERSION:          0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#USAGE:            ./mysql_backup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#CRON:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># æ¯å¤©å‡Œæ™¨ 00:00 æ‰§è¡Œæ•°æ®åº“å¤‡ä»½çš„ cron ç¤ºä¾‹</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 0 0 * * *   /Users/[your user name]/scripts/mysql_backup.sh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»å¤‡ä»½æ¢å¤</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#$  gunzip &lt; [backupfile.sql.gz] | mysql -u [uname] -p[pass] [dbname]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡ªå®šä¹‰è®¾ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># YYYY-MM-DD</span>
</span></span><span style="display:flex;"><span>TIMESTAMP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +%F<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¤‡ä»½ç›®å½•</span>
</span></span><span style="display:flex;"><span>BACKUP_DIR<span style="color:#f92672">=</span>/data/backup/$TIMESTAMP
</span></span><span style="display:flex;"><span>mkdir $BACKUP_DIR
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MYSQL ç”¨æˆ·å¯†ç </span>
</span></span><span style="display:flex;"><span>MYSQL_UNAME<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>MYSQL_PWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mysqldump å‘½ä»¤</span>
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>$PATH:/opt/mysql/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿ç•™å¤©æ•°</span>
</span></span><span style="display:flex;"><span>KEEP_BACKUPS_FOR<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> <span style="color:#75715e">#days</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ–¹æ³•</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤7å¤©å‰å¤‡ä»½æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> delete_old_backups<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;æ­£åœ¨åˆ é™¤ </span>$BACKUP_DIR<span style="color:#e6db74">/*.sql.gz </span>$KEEP_BACKUPS_FOR<span style="color:#e6db74"> å¤©å‰çš„å¤‡ä»½æ–‡ä»¶&#34;</span>
</span></span><span style="display:flex;"><span>  find $BACKUP_DIR -type d -ctime +7 -exec rm -rf <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç™»é™† mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> mysql_login<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  local mysql_login<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-u </span>$MYSQL_UNAME<span style="color:#e6db74">&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$MYSQL_PWORD<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    local mysql_login<span style="color:#f92672">+=</span><span style="color:#e6db74">&#34; -p</span>$MYSQL_PWORD<span style="color:#e6db74">&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  echo $mysql_login
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ—å‡º MySQL æ•°æ®åº“ä¸­çš„æ•°æ®åº“åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> database_list<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  local show_databases_sql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;SHOW DATABASES&#34;</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#66d9ef">$(</span>mysql <span style="color:#66d9ef">$(</span>mysql_login<span style="color:#66d9ef">)</span> -e <span style="color:#e6db74">&#34;</span>$show_databases_sql<span style="color:#e6db74">&#34;</span>|awk -F <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#e6db74">&#39;{if (NR!=1) print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> echo_status<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#39;\r&#39;</span>; 
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#39; %0.s&#39;</span> <span style="color:#f92672">{</span>0..100<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#39;\r&#39;</span>; 
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;\r&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…¨é‡å¤‡ä»½</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> backup_database<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    backup_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$BACKUP_DIR<span style="color:#e6db74">/</span>$TIMESTAMP<span style="color:#e6db74">.</span>$database<span style="color:#e6db74">.sql.gz&#34;</span> 
</span></span><span style="display:flex;"><span>    output<span style="color:#f92672">+=</span><span style="color:#e6db74">&#34;</span>$database<span style="color:#e6db74"> =&gt; </span>$backup_file<span style="color:#e6db74">\n&#34;</span>
</span></span><span style="display:flex;"><span>    echo_status <span style="color:#e6db74">&#34;...backing up </span>$count<span style="color:#e6db74"> of </span>$total<span style="color:#e6db74"> databases: </span>$database<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">$(</span>mysqldump <span style="color:#66d9ef">$(</span>mysql_login<span style="color:#66d9ef">)</span> $database | gzip -9 &gt; $backup_file<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> backup_databases<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  local databases<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>database_list<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  local total<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $databases | wc -w | xargs<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  local output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  local count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> database in $databases; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    backup_database
</span></span><span style="display:flex;"><span>    local count<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>count+1<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>  echo -ne $output | column -t
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> hr<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#39;=%.0s&#39;</span> <span style="color:#f92672">{</span>1..100<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  printf <span style="color:#e6db74">&#34;\n&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RUN SCRIPT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#==============================================================================</span>
</span></span><span style="display:flex;"><span>delete_old_backups
</span></span><span style="display:flex;"><span>hr
</span></span><span style="display:flex;"><span>backup_databases
</span></span><span style="display:flex;"><span>hr
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;All backed up!\n\n&#34;</span>
</span></span></code></pre></div>
        </div>
    </div>
</div>
