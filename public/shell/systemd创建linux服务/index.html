
<script src="/docsgo/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=docsgo/livereload" data-no-instant defer></script><div class="footer-content ">
    <div class="row" style="display: flex; justify-content: center; align-items: center;">

        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img class="float-right" src="http://localhost:1313/docsgo/punching.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
        <div class="col-md-6 col-md-offset-1 vcenter">
            <div class="quote" style="font-size: 1.5em; font-family: 'Courier New', Courier, monospace; color: #888; margin-left: 20px; margin-right: 20px; text-align: center;">â€œæˆåŠŸç»éå¶ç„¶ã€‚ è¿™æ˜¯åŠªåŠ›å·¥ä½œã€åšæŒä¸æ‡ˆã€å­¦ä¹ ã€å­¦ä¹ ã€ç‰ºç‰²ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œçƒ­çˆ±ä½ æ­£åœ¨åšçš„äº‹æƒ…æˆ–æ­£åœ¨å­¦ä¹ çš„äº‹æƒ…ã€‚â€ - è´åˆ©</div>
        </div>
        <div class="col-md-4 col-md-offset-0 vcenter">
            <div style="text-align: center;">
                <img src="http://localhost:1313/docsgo/success.gif" style="width: 40%">
                <br>
                <br>
            </div>
        </div>
    </div>
</div>
<div id="article" style="padding-left: 20px; padding-right: 20px;">
    <div class="article-title">
        <h1>Systemdåˆ›å»ºLinuxæœåŠ¡</h1>
    </div>
    
    
    <time datetime="2024-04-01T17:03:58&#43;08:00">April 1, 2024</time>
    <hr/>
    <aside>
        <p> ç›®å½•: </p>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#systemdåˆ›å»ºlinuxæœåŠ¡">Systemdåˆ›å»ºLinuxæœåŠ¡</a>
      <ul>
        <li><a href="#å¯ä»¥é‡‡å–å‡ ç§æ–¹æ³•">å¯ä»¥é‡‡å–å‡ ç§æ–¹æ³•</a></li>
        <li><a href="#systemd-å¯åŠ¨ç¤ºä¾‹">systemd å¯åŠ¨ç¤ºä¾‹</a></li>
        <li><a href="#ç®¡ç†æœåŠ¡çš„ä¾èµ–é¡¹">ç®¡ç†æœåŠ¡çš„ä¾èµ–é¡¹</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </aside>
    <hr>
    <div class="post">
        <div id="content-font">
            <h2 id="systemdåˆ›å»ºlinuxæœåŠ¡">Systemdåˆ›å»ºLinuxæœåŠ¡</h2>
<p>ğŸ¤” éœ€è¦åˆ›å»ºä¸€ä¸ªè„šæœ¬å¹¶åœ¨åå°è¿è¡Œå®ƒ</p>
<h3 id="å¯ä»¥é‡‡å–å‡ ç§æ–¹æ³•">å¯ä»¥é‡‡å–å‡ ç§æ–¹æ³•</h3>
<ol>
<li>ä¹Ÿè®¸æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨å‘½ä»¤æœ«å°¾æ·»åŠ ä¸€ä¸ª<code>&amp;</code>  å¦å¤–ï¼Œå¦‚æœæƒ³å…³é—­ç»ˆç«¯ï¼Œè¿½åŠ <code>nohup</code>ã€‚âš ï¸ å¦‚æœçš„è„šæœ¬ç”±äºæŸç§åŸå› å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°å¯åŠ¨å®ƒã€‚</li>
<li>æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨Linux çš„ï¼š <a href="https://systemd.io/">systemd</a></li>
</ol>
<p>å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªç®€å•çš„ systemd æœåŠ¡ï¼Œè¯¥æœåŠ¡å¯ä»¥åœ¨åå°è¿è¡Œè„šæœ¬å¹¶åœ¨å‡ºç°æ•…éšœæ—¶é‡æ–°å¯åŠ¨å®ƒ</p>
<h3 id="systemd-å¯åŠ¨ç¤ºä¾‹">systemd å¯åŠ¨ç¤ºä¾‹</h3>
<ol>
<li>åˆ›å»ºä¸€ä¸ªç®€å•çš„ Python HTTP æœåŠ¡å™¨</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vim my_server.py
</span></span></code></pre></div><ol start="2">
<li>æ¥å— HTTP GET è¯·æ±‚å¹¶å°†<code>Hello</code>å­—ç¬¦ä¸²è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> http.server <span style="color:#f92672">import</span> BaseHTTPRequestHandler, HTTPServer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hostName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>serverPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyServer</span>(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#34;Content-type&#34;</span>, <span style="color:#e6db74">&#34;text/html&#34;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(bytes(<span style="color:#e6db74">&#34;Hello</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    webServer <span style="color:#f92672">=</span> HTTPServer((hostName, serverPort), MyServer)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Server started http://</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (hostName, serverPort))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        webServer<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    webServer<span style="color:#f92672">.</span>server_close()
</span></span></code></pre></div><p>å°è¯•åœ¨å‰å°è¿è¡Œï¼Œç¡®ä¿pyè„šæœ¬æ­£å¸¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3 my_server.py
</span></span></code></pre></div><p>ç„¶åæ‰“å¼€ä¸€ä¸ªæ–°çª—å£å¹¶ï¼Œå°è¯•ä½¿ç”¨å‘½ä»¤è®¿é—®æœåŠ¡å™¨<code>curl</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl localhost:8080/hello
</span></span></code></pre></div><ol start="3">
<li>åˆ›å»º Systemd Linux æœåŠ¡</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vim /etc/systemd/system/my-server.service
</span></span></code></pre></div><p>ç¡®ä¿æŒ‡å®šçš„å‘½ä»¤</p>
<ul>
<li>L<code>User</code>å’Œ<code>ExecStart</code>å¯åŠ¨æœåŠ¡å™¨çš„å‘½ä»¤</li>
<li><code>Environment</code>ï¼šå‘è„šæœ¬æä¾›å˜é‡ã€‚ï¼ˆå¯é€‰ï¼‰</li>
<li><code>Restart</code>ï¼šé‡è¦çš„å‚æ•°ï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸º<code>always</code> æˆ– <code>on-failure</code>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Restart=always,  å¦‚æœåœ¨ 10 ç§’é—´éš”å†…å¯åŠ¨å¤±è´¥è¶…è¿‡ 5 æ¬¡ï¼Œsystemd å°†æ”¾å¼ƒé‡æ–°å¯åŠ¨æœåŠ¡ã€‚</code>RestartSec`æŒ‡ä»¤ä¹Ÿä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ï¼šå¦‚æœå°†å…¶è®¾ç½®ä¸º 3 ç§’åé‡æ–°å¯åŠ¨ï¼Œé‚£ä¹ˆæ°¸è¿œä¸ä¼šåœ¨ 10 ç§’å†…é‡è¯• 5 æ¬¡å¤±è´¥ã€‚</li>
</ul>
<p>â€‹	<strong>å§‹ç»ˆæœ‰æ•ˆçš„ç®€å•ä¿®å¤æ–¹æ³•æ˜¯è®¾ç½®</strong><code>StartLimitIntervalSec=0</code>.è¿™æ ·ï¼Œsystemd å°†å°è¯•æ°¸è¿œé‡æ–°å¯åŠ¨æœåŠ¡ã€‚ä¸è¿‡ï¼Œæœ€å¥½è®¾ç½®<code>RestartSec</code>ä¸ºè‡³å°‘ 1 ç§’ï¼Œä»¥é¿å…åœ¨å‡ºç°é—®é¢˜æ—¶ç»™æœåŠ¡å™¨å¸¦æ¥å¤ªå¤§å‹åŠ›ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>My Server
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>StartLimitIntervalSec<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type<span style="color:#f92672">=</span>simple
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/bin/python3 /home/ubuntu/my_server.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User<span style="color:#f92672">=</span>ubuntu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span>ENV<span style="color:#f92672">=</span>production
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span></code></pre></div><p>æµ‹è¯•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo systemctl start my-server
</span></span><span style="display:flex;"><span>sudo systemctl enable my-server
</span></span></code></pre></div><p>ç„¶åæ£€æŸ¥çŠ¶æ€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo systemctl status my-server
</span></span></code></pre></div><p>å¦‚æœå¤±è´¥ï¼Œå¹¶ä¸”éœ€è¦æŸ¥æ‰¾åŸå› ï¼Œæˆ–è€…åªæƒ³è·Ÿè¸ªæ—¥å¿—ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>journactl</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>journalctl -u my-server -f --no-pager
</span></span></code></pre></div><p>ç”¨äº<code>curl</code>æµ‹è¯•ã€‚</p>
<pre tabindex="0"><code>curl localhost:8080/hello
</code></pre><h3 id="ç®¡ç†æœåŠ¡çš„ä¾èµ–é¡¹">ç®¡ç†æœåŠ¡çš„ä¾èµ–é¡¹</h3>
<p>è®¨è®ºçš„æœ€åä¸€ä»¶äº‹æ˜¯å¯ä»¥ç®¡ç†æœåŠ¡çš„<strong>ä¾èµ–é¡¹</strong>ã€‚</p>
<p>â€‹	ä¾‹å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨éœ€è¦æ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨<code>After=postgresql.service</code>æŒ‡ä»¤æŒ‡ç¤º systemd ä»…åœ¨ Postgres å¯åŠ¨åå¯åŠ¨ python æœåŠ¡å™¨ã€‚</p>
<p>â€‹	<strong>åªæœ‰å½“ Linux å¯åŠ¨å¹¶ä¸”è¿™ä¸¤ä¸ªæœåŠ¡éƒ½å¯ç”¨æ—¶ï¼Œè¿™æ‰ä¼šèµ·ä½œç”¨</strong>ã€‚</p>
<p>â€‹	å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ å¦ä¸€ä¸ª<code>Requires=postgresql.service</code>æŒ‡ä»¤ã€‚å³ä½¿ Progress å·²å…³é—­å¹¶ä¸”å°è¯•å¯åŠ¨ Python æœåŠ¡å™¨ï¼Œsystemd ä¹Ÿä¼šé¦–å…ˆå¯åŠ¨ Postgresï¼Œç„¶åå¯åŠ¨ç¨‹åºã€‚</p>

        </div>
    </div>
</div>
