+++
title = '0 å…¥é—¨'
date = 2024-04-07T21:14:26+08:00
draft = true
+++

ansible å’Œ Terraform æ˜¯æœ€å—æ¬¢è¿çš„åŸºç¡€è®¾æ–½ä»£ç ä¹‹ä¸€

ä»è¡¨é¢ä¸Šçœ‹ï¼ŒAnsible å¯ä»¥å®Œæˆä¸ Terraform ç›¸åŒç±»å‹çš„åŸºç¡€è®¾æ–½é…ç½®ã€‚ç„¶è€Œï¼Œå®ƒä»¬åœ¨æ¶æ„ä¸Šæœ‰æ ¹æœ¬çš„ä¸åŒâ€”â€”Ansible æ˜¯ä¸€ä¸ªå‘½ä»¤å¼è„šæœ¬æ‰§è¡Œå¼•æ“ï¼Œå®ƒå°†æŒ‰ç…§ä»£ç ä¸­åˆ—å‡ºçš„é¡ºåºè¿è¡Œä»»åŠ¡ï¼Œè€Œ Terraform æ˜¯ä¸€ä¸ªå£°æ˜å¼æ‰§è¡Œå¼•æ“ï¼Œå®ƒå°†å¹¶è¡ŒåŒ–å½¼æ­¤ä¸ç›´æ¥ä¾èµ–çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œé™¤äº†éå¸¸å°çš„ä»£ç åº“ä¹‹å¤–ï¼ŒTerraform çš„æ‰§è¡Œé€Ÿåº¦æ¯” Ansible å¿«å¾—å¤šã€‚

ï¼ˆé¡ºä¾¿è¯´ä¸€å¥ï¼Œå¤§è§„æ¨¡æ‰§è¡Œé€Ÿåº¦æ…¢æ˜¯ Ansible çš„ä¸»è¦å¼±ç‚¹ã€‚ï¼‰

Terraform åŸºäºå›¾å½¢çš„æ€§è´¨è¿˜ä½¿å¾—å¯ä»¥ä½¿ç”¨ä¸åˆ›å»ºåŸºç¡€è®¾æ–½å®Œå…¨ç›¸åŒçš„ä»£ç æ¥é”€æ¯åŸºç¡€è®¾æ–½ï¼Œè€Œ Ansible éœ€è¦å•ç‹¬çš„å‰§æœ¬æ¥åˆ›å»ºå’Œé”€æ¯ã€‚å¯¹äºå®šæœŸåˆ›å»ºå’Œé”€æ¯çš„ç¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œå¼€å‘/æµ‹è¯•/ç™»å°ï¼‰ï¼ŒTerraform çš„æ–¹æ³•æ—¢å¯ä»¥å¤§å¹…æé«˜ç”Ÿäº§åŠ›ï¼Œåˆå¯ä»¥å‡å°‘äººä¸ºé”™è¯¯çš„æœºä¼šã€‚

æœ€åï¼Œè™½ç„¶è¿™ä¸ä¸€å®šæ˜¯ Ansible çš„æŠ€æœ¯ç¼ºé™·ï¼Œä½†åœ¨åŸºç¡€è®¾æ–½é…ç½®æ–¹é¢ï¼ŒTerraform è¿„ä»Šä¸ºæ­¢æ‹¥æœ‰æœ€å¤šçš„ç¤¾åŒºå’Œå¼€å‘ç†å¿µã€‚ä¸ä»»ä½•å…¶ä»–åŸºç¡€è®¾æ–½é…ç½®å·¥å…·ç›¸æ¯”ï¼Œæ‚¨æ›´æœ‰å¯èƒ½æ‰¾åˆ° Terraform çš„æ”¯æŒèµ„æºï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›ä»¥ç¼–ç¨‹æ–¹å¼é…ç½®çš„æ–°äº§å“å¯èƒ½ä¼šé¦–å…ˆåœ¨ Terraform ä¸­è·å¾—æ”¯æŒã€‚











Ansibleï¼šå¼€æºçš„é…ç½®ç®¡ç†ã€è½¯ä»¶é…ç½®å’Œåº”ç”¨éƒ¨ç½²å·¥å…·é›†ã€‚

+ è½¯ä»¶å®šä¹‰åŸºç¡€è®¾æ–½

Modulesï¼šAnsibleæˆåŠŸçš„ä¸€ä¸ªä¸»è¦å› ç´ æ˜¯å› ä¸ºæœ‰å¤§é‡çš„æ¨¡å—å¯ä¾›å…¬å¼€ä½¿ç”¨ã€‚



##  ğŸš€ Ansble  å®éªŒç¯å¢ƒ

1. ç¯å¢ƒï¼šDocker - MACï¼ˆDocker Desktopï¼‰
2. Docker compose å»ºç«‹ç¯å¢ƒ
3. Ansible æ˜¯æ— ä»£ç†çš„æ¶æ„ï¼ŒSSH é…ç½®ä¸»æœºä¹‹é—´æ— å¯†ç è¿æ¥

ğŸ§ª[å®éªŒ](https://github.com/spurin/diveintoansible-lab?tab=readme-ov-file)





è®¿é—®ï¼šhttp://localhost:1000

å¯†ç ï¼šroot/ansibleã€password

è¿æ¥åˆ°å…¶ä»–ä¸»æœºä¸å¸Œæœ›ä½¿ç”¨å¯†ç ï¼š

+ SSH ç§æœ‰å’Œå…¬é’¥

æ§åˆ¶ç«¯ ç§é’¥å°†ä¸è¢«æ§ç«¯çš„å…¬é’¥è¿›è¡ŒéªŒè¯

```sh
ansible@ubuntu-c:~$ ssh-keygen 
...
+---[RSA 3072]----+
|*...==B=oo.      |
|oo .o++oo. o     |
|. .  o o= + .    |
|   . ..* = o     |
|  . . = S o . o  |
| . + . o . . o . |
|  . o . o . . .  |
| . .   o .   . . |
| .E.    o     .  |
+----[SHA256]-----+
ansible@ubuntu-c:~$ ls .ssh/
id_rsa  id_rsa.pub  known_hosts  known_hosts.old
ansible@ubuntu-c:~$ cat .ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDFYBkgsKG7u9s/pc+S8iUsdlYvVslFqsYD1XZ364pHXaaOO7th1JuFDa9p20rFzDT3cfpBvyOvgyIfFMNADZ53dMODBDAWpOQHcMPKaCFeiom/dTl5ub2NKIsQeN1HApfVqOXKpEUdXPuAIr+UJoMLegX8ASvdprn/X5LnsluOdCTk44fA5WxFadAJlfk7dNE2dh8XDG/Gg6M/37n+Ncaed3KHqja6y329easyR/bMwPh9XfHOwqLovgVgI2UVZDNmnsCCVNYfbpFy4bbpszGuVhvymwDr/nRZkx2b3lSDtJfKucopxG+HXphDgC7/8/OzFEVAv7voLeO9ZWIzIVdPCXy2u86peP+3crDKu+DyZqY7ZszMKTKed52kqubF+qD7hWssajSYrdJgduttTZVD/AsRrAIyN4dkyi7C8kTHOScAgvgUIhsFcN90oufnStV0Si9+Z+7Hn+6dtkRmO7Poxi2vq7dNcWsajASQLthrnpD6WpPjj2wxSoRs+GbGQIM= ansible@ubuntu-c
```

+ å…¬é’¥ï¼šæ·»åŠ äº†ç”¨æˆ· ä¸»æœºå

å¤åˆ¶å…¬é’¥ --- > å…¶ä»–ä¸»æœº

```sh
$ for server in ubuntu1 ubuntu2 ubuntu3 centos1 centos2 centos3; do ssh-copy-id ansible@${server}; done
```

è§£å†³æ‰‹åŠ¨è¾“å…¥å¯†ç æ–¹æ³•ï¼š`sshpass`

```sh
$ sudo apt updat
$ sudo apt install sshpass
```

åˆ›å»ºä¸€ä¸ªï¼špassword.txtå¯†ç æ–‡ä»¶

```sh
$ echo passowrd >> password.txt

for user in root ansible
 do
   for node in centos ubuntu
   do
     for instance in 1 2 3
     do
       c${user}@${node}${instance}
     done
   done
 done
```

åˆ é™¤å¯†ç æ–‡ä»¶

```
rm password.txt
```

ğŸ¯ å¿«é€Ÿæµ‹è¯•

+ æ£€æŸ¥

```sh
$ ansible -i,ubuntu1,ubuntu2,ubuntu3,centos1,centos2,centos3 all -m ping
```



åˆ é™¤äº† `rm .ssh/known_hosts`

```sh
$ git clone https://github.com/spurin/diveintoansible.git
```





## ğŸ“’ Doc



### â›³ï¸ Ansibleçš„æ¶æ„å’Œè®¾è®¡





### ğŸ„ Ansible inventories

```sh
ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/01$ cat ansible.cfg 
[defaults]
inventory = hosts
ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/01$ cat hosts 
[all]
centos1
```

åœ¨åˆ é™¤æ–‡ä»¶`rm -rf /home/ansible/.ssh/known_hosts`

 ![image-20240110210608919](../../../../../devops_notes/ansible/images/ansible/image-20240110210608919.png)

Ansible å°è¯•ä½¿ç”¨ ssh è¿æ¥ centos1ï¼šç­‰å¾…æ‰‹åŠ¨è¾“å…¥

+ å¯ä»¥ä½¿ç”¨ å¿½ç•¥æ£€æŸ¥ï¼

```sh
ANSIBLE_HOST_KEY_CHECKING=False
```

 ![image-20240110210850867](../../../../../devops_notes/ansible/images/ansible/image-20240110210850867.png)

è™½ç„¶ç¯å¢ƒå˜é‡å¾ˆç®€å•ï¼Œä¸å¸Œæœ›æ¯æ¬¡éƒ½è®°ä½ä½¿ç”¨å®ƒ 

ğŸ¯ `ansible.cfg`

```sh
[defaults]
inventory = hosts
host_key_checking = False
```



å¤šä¸»æœºï¼š

```sh
ansible@ubuntu-c:~/diveintoansible/Ansible Architecture and Design/Inventories/03$ cat hosts 
[centos]
centos1
centos2
centos3

[ubuntu]
ubuntu1
ubuntu2
ubuntu3

$ ansible all -m ping 
$ ansible centos -m ping
$ ansible ubuntu -m ping
$ ansible '*' -m ping
```

é€‰é¡¹ï¼š`-o`  ç®€è¦è¾“å‡º

![image-20240110211616276](../../../../../devops_notes/ansible/images/ansible/image-20240110211616276.png)

é€‰é¡¹ï¼š`--list-hosts` ![image-20240110211737464](../../../../../devops_notes/ansible/images/ansible/image-20240110211737464.png)

æ­£åˆ™ï¼š

- `~`: åŒ¹é…ä»¥æŒ‡å®šæ¨¡å¼å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚
- `.*`: åŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„å­—ç¬¦ï¼ˆé™¤äº†æ¢è¡Œç¬¦ï¼‰ã€‚
- `3`: åŒ¹é…å­—ç¬¦ "3"ã€‚

```sh
$ ansible ~.*3 --list-hosts
  hosts (2):
    centos3
    ubuntu3
```



ğŸ„ ä»¥ sudo æ‰§è¡Œ 

ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ ansibleçš„å‡çº§æƒé™ - rootæƒé™

```sh
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_user=root ansible_port=22
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1 ansible_become=true ansible_become_pass=password
ubuntu2 ansible_become=true ansible_become_pass=password
ubuntu3 ansible_become=true ansible_become_pass=password
```

å®éªŒç¯å¢ƒå¯ä»¥è¿™æ ·åšï¼Œåœ¨ç”Ÿäº§ä¸­é€šå¸¸ä»¥æ™®é€šç”¨æˆ·è¿æ¥åˆ°ä¸»æœºï¼Œç„¶åå†å‡çº§åˆ° sudo ç”¨æˆ·

å½“ ssh é»˜è®¤ç«¯å£è¢«ä¿®æ”¹åï¼š

```sh
centos1 ansible_user=root ansible_port=2222
centos1:2222 ansible_user=root
```

![image-20240110214146135](../../../../../devops_notes/ansible/images/ansible/image-20240110214146135.png)

```sh
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_user=root ansible_port=2222
centos[2:3] ansible_user=root

[ubuntu]
ubuntu[1:3] ansible_become=true ansible_become_pass=password
```



ğŸš€ å­ vars

```sh
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password

[linux:children]
centos
ubuntu
```

 ![image-20240110215507024](../../../../../devops_notes/ansible/images/ansible/image-20240110215507024.png)



ğŸš€ ä½¿ç”¨ [all:var] å°†æ‰€æœ‰å˜é‡åº”ç”¨äºä¸»æœº

+ ä¸ä¼šè¦†ç›–åŸæœ‰ 

```sh
[all:vars]
ansible_port=1234
```



```sh
[defaults]
inventory = hosts.json
host_key_checking = False
```

ğŸš€ hosts.yaml

```yaml
---
control:
  hosts:
    ubuntu-c:
      ansible_connection: local
centos:
  hosts:
    centos1:
      ansible_port: 2222
    centos2:
    centos3:
  vars:
    ansible_user: root
ubuntu:
  hosts:
    ubuntu1:
    ubuntu2:
    ubuntu3:
  vars:
    ansible_become: true
    ansible_become_pass: password
linux:
  children:
    centos:
    ubuntu:
...
```

ä¹Ÿå¯ä»¥æ˜¯ json æ–‡ä»¶

ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®š

```sh
$ ls
ansible.cfg  hosts  hosts.json  hosts.yaml
$ ansible all -i hosts.yaml --list-hosts
  hosts (7):
    ubuntu-c
    centos1
    centos2
    centos3
    ubuntu1
    ubuntu2
    ubuntu3
```

å…¶ä»–é€‰é¡¹ ï¼š-e æŒ‡å®šé¢å¤–å˜é‡



### ğŸ“¦ Ansible Modules



#### ğŸ§© setup

æ”¶é›†è¿œç¨‹ä¸»æœºä¸­æœ‰ç”¨çš„å˜é‡ï¼Œåœ¨éšåçš„playbookä¸­ä½¿ç”¨

#### ğŸ§© file

Ansible çš„ `file` æ¨¡å—ç”¨äºç®¡ç†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å’Œç›®å½•ã€‚å®ƒæä¾›äº†ä¸€äº›å¸¸è§çš„æ–‡ä»¶å’Œç›®å½•æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹æƒé™ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº› `file` æ¨¡å—çš„å¸¸è§ç”¨æ³•ï¼š

```sh
$ ansible all -m file -a 'path=/tmp/test state=touch mode='0644''
$ ssh centos2 ls -l /tmp/test
-rw-r--r-- 1 root root 0 Jan 11 02:31 /tmp/test
```



#### ğŸ§© Color

+ çº¢è‰²ï¼šå¤±è´¥
+ é»„è‰²ï¼šæˆåŠŸ ä¸”å˜åŒ–
+ ç»¿è‰²ï¼šæˆåŠŸ

#### ğŸ§© Idempotnce

åœ¨ Ansible ä¸­ï¼Œ"Idempotence" æ˜¯æŒ‡æ— è®ºä½ è¿è¡Œä¸€ä¸ªä»»åŠ¡å¤šå°‘æ¬¡ï¼Œç³»ç»Ÿçš„çŠ¶æ€éƒ½ä¸ä¼šè¢«æ”¹å˜ã€‚è¿™æ˜¯ Ansible çš„ä¸€ä¸ªæ ¸å¿ƒåŸåˆ™ï¼Œç¡®ä¿åœ¨é‡å¤æ‰§è¡Œä»»åŠ¡æ—¶ä¸ä¼šå¯¼è‡´ä¸å¿…è¦çš„å˜æ›´ã€‚

ä¾‹å¦‚ï¼Œ`file` æ¨¡å—å’Œ `copy` æ¨¡å—éƒ½æ˜¯å…·æœ‰å¹‚ç­‰æ€§çš„æ¨¡å—ã€‚å½“ä½ ä½¿ç”¨è¿™äº›æ¨¡å—æ¥åˆ›å»ºç›®å½•ã€å¤åˆ¶æ–‡ä»¶ç­‰æ“ä½œæ—¶ï¼ŒAnsible ä¼šæ£€æŸ¥ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ï¼Œåªæœ‰å½“éœ€è¦çš„å˜æ›´å°šæœªå‘ç”Ÿæ—¶æ‰æ‰§è¡Œæ“ä½œï¼Œå¦åˆ™å°†è·³è¿‡ä»»åŠ¡ã€‚ ![image-20240111104123360](../../../../../devops_notes/ansible/images/ansible/image-20240111104123360.png)



#### ğŸ§© Copy

```sh
$ ansible all -m copy -a 'src=/tmp/x dest=/tmp/x'
```

+  "checksum": "da39a3ee5e6b4b0d3255bfef95601890afd80709", ä¼šæ ¡éªŒæ–‡ä»¶æ˜¯å¦è¢«å¤åˆ¶

å‚æ•°ï¼šremote_src=yes ã€ä¾‹ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„/tmp/x æ–‡ä»¶ å¤åˆ¶åˆ° è‡ªå·±çš„/tmp/xxã€‘éå¤åˆ¶æ§åˆ¶èŠ‚ç‚¹

+ æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹äºè¿œç¨‹ä¸»æœºçš„ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äº Ansible æ§åˆ¶èŠ‚ç‚¹



#### ğŸ§© command

ä¸ä¼šä¼ é€’é‡å®šå‘ç­‰shellå¸¸ç”¨å˜é‡



#### ğŸ§© fetch

`fetch` æ¨¡å—ç”¨äºä»è¿œç¨‹ä¸»æœºå¤åˆ¶æ–‡ä»¶åˆ° Ansible æ§åˆ¶èŠ‚ç‚¹

```sh
ansible all -m file -a 'path=/tmp/test_modules.txt state=touch'
ansible all -m fetch -a 'src=/tmp/test_modules.txt dest=/tmp/'
$ ls /tmp/centos1/tmp/test_modules.txt 
/tmp/centos1/tmp/test_modules.txt
```



#### ğŸ§© Ansible-doc



### ğŸ““ Ansible Playbook

+ Yaml
+ Playbook æ„æˆã€å˜é‡ã€æ¨¡å—ã€jinja2ã€æ‰§è¡Œ



#### â›µï¸ YAML

show_yaml_python.sh 

```
python3 -c 'import yaml,pprint;pprint.pprint(yaml.load(open("test.yaml").read(), Loader=yaml.FullLoader))'
```

Python - Ansible è½¬æ¢ 

```yaml
# Every YAML file should start with three dashes
---
 
 
# Every YAML file should end with three dots
...
```

+ å¯ä»¥è¡¨ç¤º YAMLçš„å¼€å§‹å’Œç»“æŸ

å…¶ä»–ï¼š

1. å•å¼•å·ã€åŒå¼•å·ã€æœ€ç»ˆéƒ½ä¼šè¢«è§£é‡Šæˆå•å¼•å·
2. å€¼ä¸ºæ•°å­—ï¼Œæ²¡æœ‰å¼•å· - æ•´æ•°ï¼Œæœ‰å¼•å·-å­—ç¬¦ä¸² 
3. å¤„ç†å¸ƒå°”å€¼éå¸¸å…¨é¢ï¼ˆé™¤äº†yã€nï¼‰



```sh
ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Introduction/YAML/11$ cat test.yaml 
---
# Every YAML file should start with three dashes

- item 1
- item 2
- item 3
- item 4
- item 5

# Every YAML file should end with three dots
...
ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Introduction/YAML/11$ ./show_yaml_python.sh 
['item 1', 'item 2', 'item 3', 'item 4', 'item 5']
```

+ Python åˆ—è¡¨



#### ğŸ¿ Playbook-1

```yaml
---
# YAMLæ–‡æ¡£ä»¥æ–‡æ¡£åˆ†éš”ç¬¦---å¼€å¤´
# å‡å·åœ¨YAMLä¸­è¡¨ç¤ºä¸€ä¸ªåˆ—è¡¨é¡¹ã€‚PlaybookåŒ…å«ä¸€ç³»åˆ—playsï¼Œæ¯ä¸ªplayéƒ½æ˜¯ä¸€ä¸ªå­—å…¸
- 
  # Hosts: æŒ‡å®šplayå°†åœ¨å“ªäº›ä¸»æœºä¸Šè¿è¡Œä»¥åŠå®ƒå°†ä½¿ç”¨çš„é€‰é¡¹
  # Vars: åº”ç”¨äºplayçš„å˜é‡ï¼Œä¼šåœ¨æ‰€æœ‰ç›®æ ‡ç³»ç»Ÿä¸Šç”Ÿæ•ˆ
  # Tasks: æ‰§è¡Œåœ¨playä¸­çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ­¤éƒ¨åˆ†ä¹Ÿå¯ç”¨äºå‰åä»»åŠ¡
  # Handlers: ä»ä»»åŠ¡çš„notifyé”®æ‰§è¡Œçš„å¤„ç†ç¨‹åºåˆ—è¡¨
  # Roles: è¦å¯¼å…¥playçš„è§’è‰²åˆ—è¡¨
# ä¸‰ä¸ªç‚¹è¡¨ç¤ºYAMLæ–‡æ¡£çš„ç»“å°¾
...
```

æ‰§è¡Œä¸€ä¸ª playbook

```sh
$ ls
ansible.cfg  centos_motd  hosts  motd_playbook.yaml
```

`motd_playbook.yaml:`

```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list 
# of plays, with each play being a dictionary
-
 
  # Hosts: where our play will run and options it will run with
  hosts: centos
  user: root

  # Vars: variables that will apply to the play, on all target systems

  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Configure a MOTD (message of the day)
      copy:
        src: centos_motd
        dest: /etc/motd

  # Handlers: the list of handlers that are executed as a notify key from a task

  # Roles: list of roles to be imported into the play

# Three dots indicate the end of a YAML document
...
```

 ![image-20240112212639216](../../../../../devops_notes/ansible/images/ansible/image-20240112212639216.png)



å®šä¹‰å…¶ä»–å‚æ•°ï¼š

+ become
+ connection
+ gather_factsï¼šåœ¨ä¸ä½¿ç”¨ä»»ä½• æ”¶é›†ä¿¡æ¯æ—¶ï¼Œå¯ä»¥å…³é—­

```sh
real    0m1.779s
user    0m0.819s
sys     0m0.364s
```

å…³é—­gather_factså

```sh
$ time ansible-playbook motd_playbook.yaml
real    0m0.868s
user    0m0.549s
sys     0m0.183s
```



ç¤ºä¾‹ï¼š

```yaml
---
# YAML documents begin with the document separator ---
 
# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-
 
  # Hosts: where our play will run and options it will run with
  hosts: linux
 
  # Vars: variables that will apply to the play, on all target systems
  vars:
    motd_centos: "Welcome to CentOS Linux - Ansible Rocks\n"
    motd_ubuntu: "Welcome to Ubuntu Linux - Ansible Rocks\n"
 
  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd_centos }}"
        dest: /etc/motd
      notify: MOTD changed
      when: ansible_distribution == "CentOS"

    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd_ubuntu }}"
        dest: /etc/motd
      notify: MOTD changed
      when: ansible_distribution == "Ubuntu"
 
  # Handlers: the list of handlers that are executed as a notify key from a task
  handlers:
    - name: MOTD changed
      debug:
        msg: The MOTD was changed
 
  # Roles: list of roles to be imported into the play
 
# Three dots indicate the end of a YAML document
...
```

+ notifyï¼šå½“ä»»åŠ¡æœ‰å˜åŒ–æ—¶ï¼Œè§¦å‘handlers

![image-20240112221218695](../../../../../devops_notes/ansible/images/ansible/image-20240112221218695.png)

`ansible_distribution`:

```sh
$ ansible all -m setup | grep -w "ansible_distribution"
        "ansible_distribution": "CentOS",
        "ansible_distribution": "CentOS",
        "ansible_distribution": "CentOS",
        "ansible_distribution": "Ubuntu",
        "ansible_distribution": "Ubuntu",
        "ansible_distribution": "Ubuntu",
        "ansible_distribution": "Ubuntu",
```



#### ğŸ«˜ Vars

å˜é‡ä½œä¸ºç”¨æˆ·è¾“å…¥ï¼š

```yaml
  vars_prompt:
    - name: username
      private: False
 
  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Test vars_prompt
      debug:
        msg: "{{ username }}"
```

`private: False`ï¼šè¿™è¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„å€¼ä¸ä¼šè¢«è§†ä¸ºç§å¯†ä¿¡æ¯ï¼Œå³è¾“å…¥çš„å†…å®¹å°†ä¼šè¢«æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

ä¸»æœºå˜é‡ï¼š

```yaml
  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Test hostvars with an ansible fact and collect ansible_port, dot notation, default if not found
      debug:
        msg: "{{ hostvars[ansible_hostname].ansible_port | default('22') }}"

    - name: Test hostvars with an ansible fact and collect ansible_port, dict notation, default if not found
      debug:
        msg: "{{ hostvars[ansible_hostname]['ansible_port'] | default('22') }}"
```



playbook ä¼ å…¥å˜é‡æ–¹å¼

+ ini

```ini
ansible-playbook variables_playbook.yaml -e extra_vars_key="extra vars value"
```

+ json

```json
ansible-playbook variables_playbook.yaml -e {"extra_vars_key": "extra vars value"}
```

+ yaml

```yaml
ansible-playbook variables_playbook.yaml -e {extra_vars_key: extra vars value}
```



#### ğŸ—ï¸ Playbook-2

```sh
$ tree
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ facts_playbook.yaml
â”œâ”€â”€ group_vars
â”‚   â”œâ”€â”€ centos
â”‚   â””â”€â”€ ubuntu
â”œâ”€â”€ host_vars
â”‚   â”œâ”€â”€ centos1
â”‚   â””â”€â”€ ubuntu-c
â””â”€â”€ hosts
```

`group_vars`ã€`host_vars` å’Œ `hosts` æ–‡ä»¶æ˜¯ç”¨æ¥ç»„ç»‡å’Œç®¡ç†å˜é‡çš„æ–¹å¼ï¼Œè¿™æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶å’Œé…ç½®ä¸»æœºå’Œä¸»æœºç»„ã€‚

1. **`group_vars`ï¼š**
   - è¿™ä¸ªç›®å½•ä¸­åŒ…å«äº†ç”¨äºæ•´ä¸ªä¸»æœºç»„ï¼ˆä¹Ÿç§°ä¸ºinventory groupï¼‰çš„å˜é‡ã€‚
   - æ¯ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åå¯¹åº”ä¸€ä¸ªä¸»æœºç»„çš„åå­—ã€‚
   - è¿™äº›å˜é‡å¯ä»¥è¢«ä¸»æœºç»„å†…çš„æ‰€æœ‰ä¸»æœºæ‰€å…±äº«ã€‚
2. **`host_vars`ï¼š**
   - è¿™ä¸ªç›®å½•ä¸­åŒ…å«äº†ç”¨äºå•ä¸ªä¸»æœºçš„å˜é‡ã€‚
   - æ¯ä¸ªæ–‡ä»¶çš„æ–‡ä»¶åå¯¹åº”ä¸€ä¸ªä¸»æœºçš„åå­—ã€‚
   - è¿™äº›å˜é‡åªå¯¹ç‰¹å®šçš„ä¸»æœºç”Ÿæ•ˆã€‚
3. **`hosts` æ–‡ä»¶ï¼š**
   - è¿™æ˜¯ Ansible çš„ inventory æ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†æ‰€æœ‰è¢«ç®¡ç†çš„ä¸»æœºã€‚
   - åœ¨ `hosts` æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥å°†ä¸»æœºåˆ†ç»„ï¼Œè¿™äº›ç»„å¯ä»¥å¯¹åº”åˆ° `group_vars` ä¸­çš„å˜é‡ã€‚
   - é€šè¿‡åœ¨ `hosts` æ–‡ä»¶ä¸­å®šä¹‰ä¸»æœºå’Œä¸»æœºç»„ï¼Œæ‚¨å¯ä»¥æœ‰é€‰æ‹©åœ°å°†å˜é‡åº”ç”¨åˆ°ä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„ã€‚



####  ğŸ¨ Jinja2

```sh
$ tree
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ group_vars
â”‚   â”œâ”€â”€ centos
â”‚   â””â”€â”€ ubuntu
â”œâ”€â”€ host_vars
â”‚   â”œâ”€â”€ centos1
â”‚   â””â”€â”€ ubuntu-c
â”œâ”€â”€ hosts
â”œâ”€â”€ jinja2_playbook.yaml
â””â”€â”€ template.j2
```

`jinja2_playbook.yaml`:

```yaml
  tasks:
    - name: Jinja2 template
      template:
        src: template.j2
        dest: "/tmp/{{ ansible_hostname }}_template.out"
        trim_blocks: true
        mode: 0644
```

`template.j2`:

```jinja2
--== Ansible Jinja2 if statement ==--

{# If the hostname is ubuntu-c, include a message -#}
{% if ansible_hostname == "ubuntu-c" -%}
      This is ubuntu-c
{% endif %}

--== Ansible Jinja2 if elif statement ==--

{% if ansible_hostname == "ubuntu-c" -%}
   This is ubuntu-c
{% elif ansible_hostname == "centos1" -%}
   This is centos1 with it's modified SSH Port
{% endif %}

--== Ansible Jinja2 if elif else statement ==--

{% if ansible_hostname == "ubuntu-c" -%}
   This is ubuntu-c
{% elif ansible_hostname == "centos1" -%}
   This is centos1 with it's modified SSH Port
{% else -%}
   This is good old {{ ansible_hostname }}
{% endif %}

--== Ansible Jinja2 if variable is defined ( where variable is not defined ) ==--

{% if example_variable is defined -%}
   example_variable is defined
{% else -%}
   example_variable is not defined
{% endif %}

--== Ansible Jinja2 if varible is defined ( where variable is defined ) ==--

{% set example_variable = 'defined' -%}
{% if example_variable is defined -%}
   example_variable is defined
{% else -%}
   example_variable is not defined
{% endif %}

--== Ansible Jinja2 for statement ==--

{% for entry in ansible_all_ipv4_addresses -%}
   IP Address entry {{ loop.index }} = {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range

{% for entry in range(1, 11) -%}
   {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range, reversed (simulate while greater 5) ==--

{% for entry in range(10, 0, -1) -%}
   {% if entry == 5 -%}
      {% break %}
   {% endif -%}
   {{ entry }}
{% endfor %}

--== Ansible Jinja2 for range, reversed (continue if odd) ==--

{% for entry in range(10, 0, -1) -%}
   {% if entry is odd -%}
      {% continue %}
   {% endif -%}
   {{ entry }}
{% endfor %}

---=== Ansible Jinja2 filters ===---

--== min [1, 2, 3, 4, 5] ==--

{{ [1, 2, 3, 4, 5] | min }}

--== max [1, 2, 3, 4, 5] ==--

{{ [1, 2, 3, 4, 5] | max }}

--== unique [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] ==--

{{ [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] | unique }}

--== difference [1, 2, 3, 4, 5] vs [2, 3, 4] ==--

{{ [1, 2, 3, 4, 5] | difference([2, 3, 4]) }}

--== random ['rod', 'jane', 'freddy'] ==--

{{ ['rod', 'jane', 'freddy'] | random }}

--== urlsplit hostname ==--

{{ "http://docs.ansible.com/ansible/latest/playbooks_filters.html" | urlsplit('hostname') }}
```



#### Playbook åˆ›å»ºå’Œæ‰§è¡Œ



```sh
 tree
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ files
â”‚   â””â”€â”€ playbook_stacker.zip
â”œâ”€â”€ group_vars
â”‚   â”œâ”€â”€ centos
â”‚   â””â”€â”€ ubuntu
â”œâ”€â”€ host_vars
â”‚   â”œâ”€â”€ centos1
â”‚   â””â”€â”€ ubuntu-c
â”œâ”€â”€ hosts
â”œâ”€â”€ nginx_playbook.yaml
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ index.html-ansible_managed.j2
â”‚   â”œâ”€â”€ index.html-base.j2
â”‚   â”œâ”€â”€ index.html-easter_egg.j2
â”‚   â””â”€â”€ index.html-logos.j2
â””â”€â”€ vars
    â””â”€â”€ logos.yaml
```

 ![image-20240116122759223](../../../../../devops_notes/ansible/images/ansible/image-20240116122759223.png)

`nginx_playbook.yamlæ–‡ä»¶ï¼š`

```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: linux
  
  # Vars: variables that will apply to the play, on all target systems
  vars_files:
    - vars/logos.yaml

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Install EPEL
      yum:
        name: epel-release
        update_cache: yes
        state: latest
      when: ansible_distribution == 'CentOS'

    - name: Install Nginx
      package:
        name: nginx
        state: latest

    - name: Restart nginx
      service:
        name: nginx
        state: restarted
      notify: Check HTTP Service

    - name: Template index.html-easter_egg.j2 to index.html on target
      template:
        src: index.html-easter_egg.j2
        dest: "{{ nginx_root_location }}/index.html"
        mode: 0644

    - name: Install unzip
      package:
        name: unzip
        state: latest

    - name: Unarchive playbook stacker game
      unarchive:
        src: playbook_stacker.zip
        dest: "{{ nginx_root_location }}"
        mode: 0755

  # Handlers: the list of handlers that are executed as a notify key from a task
  handlers:
    - name: Check HTTP Service
      uri:
        url: http://{{ ansible_default_ipv4.address }}
        status_code: 200 

# Three dots indicate the end of a YAML document
...
```



### ğŸš€ Ansible Playbook æ·±å…¥

+ Ansible Playbook æ¨¡å—
+ åŠ¨æ€æ¸…å•æ–‡ä»¶
+ æ‰§è¡Œä»»åŠ¡æ—¶æ”¶åˆ°çš„ä¿¡æ¯ï¼Œåœ¨ä¹‹ååˆ©ç”¨
+ å¾ªç¯
+ æ€§èƒ½ç ”ç©¶ï¼ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œï¼‰
+ ä»»åŠ¡å§”æ‰˜
+ Ansible å˜é‡ï¼ˆç‰¹æ®Šçš„ä¸€ç»„ï¼‰
+ å— - blocks
+ ä¿¡æ¯ä¿æŠ¤ - vault

####  Ansible Playbook æ¨¡å—

ä¸Šåƒç§æ¨¡å—

##### set_fact

åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å…è®¸åŠ¨æ€çš„æ”¹å˜æˆ–æ·»åŠ äº‹å®

```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: ubuntu3,centos3

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Set a fact
      set_fact:
        our_fact: Ansible Rocks!

    - name: Show custom fact
      debug:
        msg: "{{ our_fact }}"

# Three dots indicate the end of a YAML document
...
```

![image-20240116125011843](../../../../../devops_notes/ansible/images/ansible/image-20240116125011843.png)

```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: ubuntu3,centos3

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Set our installation variables for CentOS
      set_fact:
        webserver_application_port: 80
        webserver_application_path: /usr/share/nginx/html
        webserver_application_user: root
      when: ansible_distribution == 'CentOS'

    - name: Set our installation variables for Ubuntu
      set_fact:
        webserver_application_port: 8080
        webserver_application_path: /var/www/html
        webserver_application_user: nginx
      when: ansible_distribution == 'Ubuntu'

    - name: Show pre-set distribution based facts
      debug:
        msg: "webserver_application_port:{{ webserver_application_port }} webserver_application_path:{{ webserver_application_path }} webserver_application_user:{{ webserver_application_user }}"

# Three dots indicate the end of a YAML document
...
```



##### pause

https://docs.ansible.com/ansible/2.9/modules/pause_module.html#pause-module

- å°† playbook æ‰§è¡Œæš‚åœä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç›´åˆ°ç¡®è®¤æç¤ºä¸ºæ­¢ã€‚æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¯é€‰çš„ã€‚é»˜è®¤è¡Œä¸ºæ˜¯æš‚åœå¹¶å‡ºç°æç¤ºã€‚

```yaml
# æš‚åœ 10 s
- name: Pause our playbook for 10 seconds
      pause:
        seconds: 10
# æç¤ºä¿¡æ¯
- name: Prompt user to verify before continue
      pause:
        prompt: Please check that the webserver is running, press enter to continue
```



##### wait_for 

â€“ åœ¨ç»§ç»­ä¹‹å‰ç­‰å¾…æ¡

```yaml
  tasks:
  # 80ç«¯å£æ˜¯å¦running
    - name: Wait for the webserver to be running on port 80
      wait_for:
        port: 80
```



##### add_host

add_host â€“ å°†ä¸»æœºï¼ˆæˆ–è€…ç»„ï¼‰æ·»åŠ åˆ° ansible-playbook å†…å­˜æ¸…å•ä¸­

```yaml
$ cat add_host_playbook.yaml 
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: ubuntu-c

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Add centos1 to adhoc_group
      add_host:
        name: centos1
        groups: adhoc_group1, adhoc_group2

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: adhoc_group1

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Ping all in adhoc_group1
      ping:

# Three dots indicate the end of a YAML document
...
```



##### group_by

+ ä½¿ç”¨äº‹å®åˆ›å»ºä¸´æ—¶ç»„ï¼Œä»¥ä¾¿ç¨ååœ¨å‰§æœ¬ä¸­ä½¿ç”¨ã€‚

```yaml
$ cat group_by_playbook.yaml 
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: all

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Create group based on ansible_distribution
      group_by:
        key: "custom_{{ ansible_distribution | lower }}"

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: custom_centos

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Ping all in custom_centos
      ping:

# Three dots indicate the end of a YAML document
...
```



##### fetch

+ ä»è¿œç¨‹èŠ‚ç‚¹è·å–æ–‡ä»¶

- è¯¥æ¨¡å—çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº[copy](https://docs.ansible.com/ansible/2.9/modules/copy_module.html#copy-module)ï¼Œä½†æ–¹å‘ç›¸åã€‚

```yaml
- name: Store file into /tmp/fetched/host.example.com/tmp/somefile
  fetch:
    src: /tmp/somefile
    dest: /tmp/fetched

- name: Specifying a path directly
  fetch:
    src: /tmp/somefile
    dest: /tmp/prefix-{{ inventory_hostname }}
    flat: yes

- name: Specifying a destination path
  fetch:
    src: /tmp/uniquefile
    dest: /tmp/special/
    flat: yes

- name: Storing in a path relative to the playbook
  fetch:
    src: /tmp/uniquefile
    dest: special/prefix-{{ inventory_hostname }}
    flat: yes
```



#### åŠ¨æ€æ¸…å•æ–‡ä»¶

ç”¨æœ€å°çš„è„šæœ¬åˆ›å»ºåŠ¨æ€æ¸…å•æ–‡ä»¶ã€æŸ¥è¯¢ã€ä½¿ç”¨_meta æ€§èƒ½æå‡ã€ä½¿ç”¨ansible_palybook æ¡†æ¶

åˆ°ç›®å‰ï¼Œä¸€ç›´ä½¿ç”¨çš„ï¼š

```sh
$ tree
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ fetch_playbook.yaml
â”œâ”€â”€ group_vars
â”‚   â”œâ”€â”€ centos
â”‚   â””â”€â”€ ubuntu
â”œâ”€â”€ host_vars
â”‚   â”œâ”€â”€ centos1
â”‚   â””â”€â”€ ubuntu-c
â””â”€â”€ hosts
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ -i æŒ‡å®šæ¸…å•æ–‡ä»¶

`$ cat inventory.py`

```python
#!/usr/bin/env python3

'''
Dynamic inventory for Ansible in Python
'''

# Use print functionality from Python 3 for compatibility
from __future__ import print_function

import argparse
import logging

# Attempt to import json, if it fails, import simplejson
try:
    import json
except ImportError:
    import simplejson as json

# Inherit from object for Python 2/3 compatibility
class Inventory(object):

    # Constructor
    def __init__(self, include_hostvars_in_list):

        # Configure logger
        #self.configure_logger()

        # Capture and store include_hostvars_in_list
        self.include_hostvars_in_list = include_hostvars_in_list

        # Capture the script command line arguments
        parser = argparse.ArgumentParser()
        parser.add_argument('--list', action='store_true',
                            help='list inventory')
        parser.add_argument('--host', action='store',
                            help='show HOST variables')
        self.args = parser.parse_args()

        # If not called with --host or --list, show usage and exit
        if not (self.args.list or self.args.host):
            parser.print_usage()
            raise SystemExit

        # Capture and store the inventory
        self.define_inventory()

        # When called with --list, print the inventory
        if self.args.list:
            self.print_json(self.list())

        # If called with --host, print host information
        elif self.args.host:
            self.print_json(self.host())

    def define_inventory(self):
        self.groups = {
            "centos": {
                "hosts": ["centos1", "centos2", "centos3"],
                "vars": {
                    "ansible_user": 'root'
                }
            },
            "control": {
                "hosts": ["ubuntu-c"],
            },
            "ubuntu": {
                "hosts": ["ubuntu1", "ubuntu2", "ubuntu3"],
                "vars": {
                    "ansible_become": True,
                    "ansible_become_pass": 'password'
                }
            },
            "linux": {
                "children": ["centos", "ubuntu"],
            }}

        self.hostvars = {
            'centos1': {
                'ansible_port': 22
            },
            'ubuntu-c': {
                'ansible_connection': 'local'
            }
        }

    # Pretty print JSON
    def print_json(self, content):
        print(json.dumps(content, indent=4, sort_keys=True))

    # Return inventory dictionary
    def list(self):

        #self.logger.info('list executed')

        # If include_hostvars_in_list is True, merge the hostvars
        # as _meta data
        if self.include_hostvars_in_list:
            merged = self.groups
            merged['_meta'] = {}
            merged['_meta']['hostvars'] = self.hostvars
            return merged

        # Otherwise, return the groups without hostvars
        else:
            return self.groups

    # Return host dictionary
    def host(self):

        #self.logger.info('host executed for {}'.format(self.args.host))

        # If the requested hosts exists in hostvars, return it
        if self.args.host in self.hostvars:
            return self.hostvars[self.args.host]

        # Otherwise, return an empty list
        else:
            return {}

    # Logger, for debugging as stdout is used by the script
    def configure_logger(self):
        self.logger = logging.getLogger('ansible_dynamic_inventory')
        self.hdlr = logging.FileHandler('/var/tmp/ansible_dynamic_inventory.log')
        self.formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
        self.hdlr.setFormatter(self.formatter)
        self.logger.addHandler(self.hdlr) 
        self.logger.setLevel(logging.DEBUG)

# Call the Inventory class constructor (__init__)
# Pass include_hostsvars_in_list as True to include hostvars
# as _meta data in list output
Inventory(include_hostvars_in_list=True)
```

 ![image-20240116223851739](../../../../../devops_notes/ansible/images/ansible/image-20240116223851739.png)



#### æ³¨å†Œå’Œè¾“å‡º

+ å¦‚ä½•åˆ©ç”¨æ³¨å†Œè¾“å‡ºã€è§£å†³å·®å¼‚

```yaml
  tasks:
    - name: Exploring register
      command: hostname -s
      register: hostname_output

    - name: Show hostname_output
      debug:
        var: hostname_output.stdout
```

when

```yaml
  tasks:
    - name: Exploring register
      command: hostname -s
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "8"
      
    - name: Exploring register
      command: hostname -s
      when: ( ansible_distribution == "CentOS" and ansible_distribution_major_version == "8" ) or
            ( ansible_distribution == "Ubuntu" and ansible_distribution_major_version == "20" )
            
    - name: Exploring register
      command: hostname -s
      when: ( ansible_distribution == "CentOS" and ansible_distribution_major_version | int >= 8 ) or
            ( ansible_distribution == "Ubuntu" and ansible_distribution_major_version | int >= 20 )
            
    - name: Exploring register
      command: hostname -s
      when: 
        - ansible_distribution == "CentOS" 
        - ansible_distribution_major_version | int >= 8
```

register_when_playbook.yaml :

```yaml
    - name: Exploring register
      command: hostname -s
      when: 
        - ansible_distribution == "CentOS" 
        - ansible_distribution_major_version | int >= 8
      register: command_register

    - name: Install patch when changed
      yum:
        name: patch
        state: present
      when: command_register.changed
      
---
  tasks:
    - name: Exploring register
      command: hostname -s
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version | int >= 8
      register: command_register

    - name: bug
      debug:
        msg: "{{ command_register }}"

    - name: Install patch when changed
      yum:
        name: patch
        state: present
      when: command_register is changed
```



---

#### Ansible æ€§èƒ½é—®é¢˜

é€šè¿‡å†…ç½®åŠŸèƒ½æå‡

+ æ€§èƒ½ å’Œ ç“¶é¢ˆ é—®é¢˜
+ è½®è¯¢
+ å¼‚æ­¥ã€å¼‚æ­¥çŠ¶æ€å¤„ç†
+ ä¸²è¡Œæ‰§è¡Œ
+ æ‰¹é‡æ‰§è¡Œ



Using Include and Import

1. Include_tasks
2. import_tasks

æ‰§è¡Œç»“æœå¾ˆåƒï¼Œæœ€å¤§åŒºåˆ«ï¼šimport é¢„å¤„ç†ï¼Œinclude æ‰§è¡Œé‡åˆ°æ—¶å¤„ç†ï¼Œä½¿ç”¨ when æ—¶æ›´æ˜æ˜¾

https://github.com/spurin/diveintoansible/blob/master/Structuring%20Ansible%20Playbooks/Using%20Include%20and%20Import/03/include_import_tasks_playbook.yaml

```sh
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: centos1

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:

     - debug:
         msg: ===================== Testing include_tasks =====================

     # include_tasks is dynamic
     #
     # The when statement is executed once, if the condition is met, all
     # tasks are executed
     - include_tasks: include_tasks.yaml
       when: include_tasks_var is not defined

     - debug:
         msg: ===================== Testing import_tasks ======================

     # import_tasks is static
     #
     # Each task that in the include will be independently executed against
     # the when condition
     - import_tasks: import_tasks.yaml
       when: import_tasks_var is not defined

# Three dots indicate the end of a YAML document
...
```



#### Tags

ä½¿ç”¨æ ‡ç­¾è¿›è¡Œç»†åˆ†

é»˜è®¤æƒ…å†µä¸‹æ˜¯`--tags "all"`

1.ä¸å¸Œæœ›æ‰§è¡Œæ•´ä¸ªå‰§æœ¬æ—¶éå¸¸æœ‰ç”¨

```
--tags ""
```

2.åä¹‹è·³è¿‡

```sh
--skips-tags ""
```

3.è®¾ç½®æ ‡ç­¾ç”¨äºæ•´ä¸ª playbook

```yaml
-
	hosts linux
  tag:
    - web
```

+ è¿™æ ·å†æŒ‡å®šå…¶ä¸­çš„ tasks ä¸­çš„ tags æ—¶ ä¼šè·³è¿‡ Facts

4.æ€»æ˜¯è¿è¡Œã€å¯ä»¥ä½¿ç”¨--skips-tags è·³è¿‡ã€‘

```yaml
      tags:
        - always
```



#### Roles

è§’è‰²çš„æœ¬è´¨æ˜¯ç›®å½•ç»“æ„

ansible-galaxy æŒºæ¾åˆ›å»ºç›®å½•æ¶æ„

 
