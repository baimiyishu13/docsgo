+++
title = '第5章：生产环境中的管道'
date = 2024-04-23T15:42:55+08:00
draft = true
+++

将构建打包应用程序，构建镜像打包部署到环境

使用项目：https://gitlab.com/baimiyishu13/mynodeapp-cicd-project，构建一个完整的 cicd 管道

具体有以下步骤：

1. 单元测试
2. STAT 应用程序安全测试，扫描代码安全
3. docker build
4. docker push Registry
5. deploy -DEV
6. deploy -test
7. deploy-生产

---

## 第一步：单元测试

```yml
---
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "merge_request_event"
      when: never
    - when: always

run_unit_test:
   image: node:21-alpine
   tags:
     - ec2
     - aws
     - docker
   before_script:
     - cd app
     - npm install
   script:
     - npm test
   artifacts:
     when: always
     paths:
     - app/junit.xml
     reports:
       junit: app/junit.xml
```

解释：

+ artifacts 关键字用于指定在 job 运行后需要保存的文件或目录
+ path: app/junit.xml 指定了需要保存的文件或目录的路径
+ reports 是一个映射，它的键是报告类型，值是报告文件的路径
  + junit: app/junit.xml 指定了生成的 JUnit 测试报告的路径

报告必须是 xml

![image-20240423170335882](/images/image-20240423170335882.png "Title")

测试报告

![image-20240423170459380](/images/image-20240423170459380.png "Title")



下载报告：

+ paths 参数

```yaml
   artifacts:
     when: always
     paths:
     - app/junit.xml
     reports:
       junit: app/junit.xml
```

![image-20240423171509168](/images/image-20240423171509168.png "Title")



测试失败：

![image-20240423172003356](/images/image-20240423172003356.png "Title")



如果开发人员想重一些东西：

如果不小心删除了 Dockerfile, 然后创建合并

这一步测试将会失败：

![image-20240423172506995](/images/image-20240423172506995.png "Title")

![image-20240423173312957](/images/image-20240423173312957.png "Title")



## 第二步：镜像

构建

push 

github 实际上为每个项目提供了一个内置的 docker registry

位置：gitlab - 部署 - 容器镜像库

push/pull 镜像，需要 login 认证凭证

每个项目都有自己的 docker registry



访问 /var/run/docker.sock 权限不足

```sh
sudo usermod -aG docker gitlab-runner
gitlab-runner restart
```

+ CI_REGISTRY
+ CI_REGISTRY_IMAGE
+ CI_REGISTRY_PASSWORD
+ CI_REGISTRY_USER

```yaml
build_image:
  stage: build
  tags:
    - ec2
    - aws
    - shell
  script:
    - docker build -t registry.gitlab.com/baimiyishu13/mynodeapp-cicd-project:1.0 .
    # - docker build -t $CI_REGISTRY_IMAGE:1.0 .

push_image:
  stage: build
  needs:
    - build_image
  tags:
    - ec2
    - aws
    - shell
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com
    # - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REPOSITORY_URL
  script:
    - docker push registry.gitlab.com/baimiyishu13/mynodeapp-cicd-project:1.0
   # - docker push $CI_REGISTRY_IMAGE:1.0
```



![image-20240423223746145](/images/image-20240423223746145.png "Title")

![image-20240423223801905](/images/image-20240423223801905.png "Title") 



