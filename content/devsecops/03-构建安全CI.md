+++
title = '第3章：构建安全CI'
date = 2024-04-28T15:42:54+08:00
draft = true

+++

从一个项目开始：https://gitlab.com/baimiyishu13/juice-shop

可以完美展示应用程序代码和配置中的安全问题。

+ 不需要理解 99% 代码，只是使用

创建管道文件：gitlab-ci.yml

docker 镜像：https://hub.docker.com/_/docker

使用，无需使用 shell 去安装docker 构建

```yml
  image: docker:26
  services:
    - docker:26-dind
```



先构建服务镜像：

```sh
---
stages:
  - test
  - build

variables:
  GIT_DEPTH: 0
  IMAGE_NAME: $CI_REGISTRY_IMAGE/demo-app
  IMAGE_TAG: juice-shop-1.1

yarn_test:
  image: node:18-alpine3.18
  script:
    - yarn install
    - yarn test

build_image:
  stage: build
  image: docker:26
  services:
    - docker:26-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
```



使用的共享 runner ，差不多花费了 15min，来执行这两项任务。

这两个作业都是长时间作业，安装一堆依赖

1. yarn install
2. dockerfile 构建安装一堆 【很多层】









