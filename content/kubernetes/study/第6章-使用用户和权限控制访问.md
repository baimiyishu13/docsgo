+++
title = '第5章 使用用户和权限控制访问'
date = 2024-05-04T22:10:20+08:00
draft = true
+++

## 1 - 章节简介

权限：

1. 谁可以访问？【并不是每个人都是管理员】
2. 访问什么资源？做什么事情？

授用户或应用程序的四种方法：

1. Node：节点鉴权是一种特殊用途的鉴权模式，专门对 kubelet 发出的 API 请求进行授权。
2. ABAC：基于属性的访问控制（Attribute-based access control，ABAC）定义了访问控制范例， ABAC 通过使用将属性组合在一起的策略来向用户授予访问权限。
3. RBAC：基于角色（Role）的访问控制（RBAC）是一种基于组织中用户的角色来调节控制对计算机或网络资源的访问的方法。
4. WebHook：具体来说，当在判断用户权限时，`Webhook` 模式会使 Kubernetes 查询外部的 REST 服务。

但是，我们实际上只需要了解RBAC

在 apiserver配置中，`--authorization-mode=Node,RBAC`



## 2-将用户和权限与 RBAC 角色解耦

当在CMD使用 kubectl 执行命令时，会发生：

1. kubectl 读取本地的 kubeconfig 配置
2. 将访问kubenetes api server，并发现API 【着仅仅是检查API可用性】
3. kubectl 将执行客户端验证【检查 yml 中是否有错误】
4. 将数据发送给 api server 请求，收到请求并不会直接存储在 etcd 中
5. 首先，验证请求是否合法【对请求做身份验证 - 是否有权限创建这些资源】，有权限访问集群并不意味着有权限创建、读取、删除等等 【通常通过 RBAC来控制，精细的控制权限】
6. 如果未授权，则返回401，否则进入下一步



## 3 - Kubernetes RBAC

==RBAC：意在根据个人角色授权对资源的访问==

从头开始设计授权系统

1.  为权限定义一个通用的 role
2. 将权限分配给role，而不是直接向用户分配权限
3. 将 role 链接到 用户



RBAC：

+ identity：SA，首先需要一个SA账户
+ Role：访问资源的权限
+ RoleBinding：角色绑定



## 4 - Kubernetes 身份：用户、应用程序和组

例如：有人想登陆k8s 的默认仪表盘，那么需要

一个用户账户 【集群中创建sA】

还可以定义一组用户或 SA账户，如果想定义一个 NS的SA账户也可以



限制对资源访问最佳方法是控制如何请求这些 API接口

1. 资源本身的API
2. 授权访问【只读、读写等等】
   + *
   + get
   + list
   + create
   + patch
   + delete等等

下面是一个位于 "default" 名字空间的 Role 的示例，可用来授予对 [Pod](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/) 的读访问权限：

```yml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""] # "" 标明 core API 组
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
```



## 5 - 向用户授予权限

RoleBinding 将 "pod-reader" Role 授予在 "default" 名字空间中的用户 "jane"。 这样，用户 "jane" 就具有了读取 "default" 名字空间中所有 Pod 的权限。

```yml
apiVersion: rbac.authorization.k8s.io/v1
# 此角色绑定允许 "jane" 读取 "default" 名字空间中的 Pod
# 你需要在该名字空间中有一个名为 “pod-reader” 的 Role
kind: RoleBinding
metadata:
  name: read-pods
  namespace: default
subjects:
# 你可以指定不止一个“subject（主体）”
- kind: User
  name: jane # "name" 是区分大小写的
  apiGroup: rbac.authorization.k8s.io
roleRef:
  # "roleRef" 指定与某 Role 或 ClusterRole 的绑定关系
  kind: Role        # 此字段必须是 Role 或 ClusterRole
  name: pod-reader  # 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配
  apiGroup: rbac.authorization.k8s.io
```



## 6 - 实践

### 场景 1：同一命名空间中的角色和 RoleBinding

### 场景 2：角色

### 场景 3：将 ClusterRole 与 RoleBinding 结合使用

### 场景 4：使用 ClusterRole 和 ClusterRoleBinding 授予集群范围的访问权限



## 7 - 使 RBAC 策略更加简洁
